<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta name="robots" content="noindex">
<title>plcm.C Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body bgcolor="#ffffff">
<!-- Generated by Doxygen 1.1.5 on Thu Sep 28 15:38:02 2000 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>plcm.C</h1><a href="plcm.C.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">// ********************************************************</font>
00002 <font class="comment">// *  PLCM Placement process                              *</font>
00003 <font class="comment">// *    @(#)plcm.C 1.40 09/01/99 Delft University of Technology </font>
00004 <font class="comment">// ********************************************************</font>
00005 
00006 <font class="preprocessor">#include &lt;stdlib.h&gt;</font>
00007 <font class="preprocessor">#include &lt;stdio.h&gt;</font>
00008 <font class="preprocessor">#include &lt;time.h&gt;</font>
00009 <font class="preprocessor">#include &lt;string.h&gt;</font>
00010 <font class="preprocessor">#include "<a class="code" href="plcm.h.html">plcm.h</a>"</font>
00011 <font class="preprocessor">#include "<a class="code" href="cluster.h.html">cluster.h</a>"</font>
00012 <font class="preprocessor">#include "<a class="code" href="plane.h.html">plane.h</a>"</font>
00013 <font class="preprocessor">#include "<a class="code" href="protArea.h.html">protArea.h</a>"</font>
00014 
00015 <font class="preprocessor">#ifdef __MSDOS__
</font>00016 <font class="preprocessor"></font><font class="preprocessor">#  include &lt;process.h&gt;</font>
00017 <font class="preprocessor">#else
</font>00018 <font class="preprocessor"></font><font class="preprocessor">#  include &lt;sys/types.h&gt;</font>
00019 <font class="preprocessor">#endif
</font>00020 <font class="preprocessor"></font>
00021 
00022 <font class="keyword">extern</font> <font class="stringliteral">"C"</font> {
00023 <font class="preprocessor">#ifndef __MSDOS__
</font>00024 <font class="preprocessor"></font>   pid_t <a class="code" href="plcm.C.html#a1">getpid</a> (<font class="keywordtype">void</font>);
00025 <font class="preprocessor">#endif
</font>00026 <font class="preprocessor"></font>
00027 }
00028 
<a name="l00029"></a><a class="code" href="plcm.C.html#a0">00029</a> <font class="preprocessor">#define  TRANS_DEBUG  1
</font>00030 <font class="preprocessor"></font><font class="comment">// #define  SLICE_DEBUG  0</font>
00031 
00032 <font class="comment">//--------------------------------------------------------------</font>
<a name="l00033"></a><a class="code" href="class_plcm.html#a0">00033</a> <a class="code" href="class_plcm.html#a0">Plcm::Plcm</a>( <font class="keywordtype">char</font> *cName, <font class="keywordtype">char</font> *fName, <font class="keywordtype">char</font> *lName,
00034            <a class="code" href="class__imagedesc.html">IMAGEDESC</a>* imageDesc,<a class="code" href="class_imagemap.html">ImageMap</a>* imMap,
00035        <font class="keywordtype">char</font> *oName,
00036        CIRCUIT *partitioned,
00037        <a class="code" href="class__global_routing.html">GLOBAL_ROUTING</a> *g_rout, 
00038        Boolean sl,
00039        Boolean da,
00040            Boolean v,Boolean p,
00041                     <font class="keywordtype">int</font> sr,<font class="keywordtype">int</font> mm):thisImage(*imageDesc),
00042                                    imageMap(imMap),
00043                        globRouting(g_rout),
00044                        <a class="code" href="phil.C.html#a11">slicingLayout</a>(sl),
00045                        doTransAna(da),
00046                        freeNets(5,0,5),
00047                        random_points(p),
00048                                        <a class="code" href="phil.C.html#a9">set_srand</a>(sr),
00049                        <a class="code" href="phil.C.html#a10">macroMinSize</a>(mm)
00050 <font class="comment">//</font>
00051 <font class="comment">// Constructor :</font>
00052 <font class="comment">// Assumes that database is already opened.</font>
00053 <font class="comment">//</font>
00054 {
00055 
00056   srand(<font class="keywordtype">int</font>( set_srand &gt; 0 ? set_srand : <a class="code" href="plcm.C.html#a1">getpid</a>()));
00057 
00058 
00059   
00060   <font class="keywordflow">if</font>(slicingLayout &amp;&amp; doTransAna)
00061     random_points=<font class="keyword">false</font>;
00062 
00063 
00064   <font class="keywordflow">if</font> (doTransAna )
00065     globRouting=NULL;
00066 
00067   
00068   circuitName=cs(cName);
00069   functionName=cs(fName);
00070   libraryName=cs(lName);
00071 
00072   <font class="keywordflow">if</font>(oName == NULL)
00073     layoutName=cs(cName);
00074   <font class="keywordflow">else</font>
00075     layoutName=cs(oName);
00076 
00077   verboseMode=v;
00078   fromPartitioner=partitioned;
00079   layInstancesList=NULL;
00080   
00081 
00082   plane=NULL;                    <font class="comment">// for future checking if "read" and "prepare"</font>
00083                                  <font class="comment">// were called</font>
00084 
00085 
00086                                    <font class="comment">// defining default "free" nets names</font>
00087 
00088   freeNets.add( *<font class="keyword">new</font> CriNet(cs(<font class="stringliteral">"vdd"</font>)));
00089   freeNets.add( *<font class="keyword">new</font> CriNet(cs(<font class="stringliteral">"vss"</font>)));
00090   freeNets.add( *<font class="keyword">new</font> CriNet(cs(<font class="stringliteral">"gnd"</font>)));
00091   freeNets.add( *<font class="keyword">new</font> CriNet(cs(<font class="stringliteral">"power"</font>)));
00092   freeNets.add( *<font class="keyword">new</font> CriNet(cs(<font class="stringliteral">"Vdd"</font>)));
00093   freeNets.add( *<font class="keyword">new</font> CriNet(cs(<font class="stringliteral">"Vdd"</font>)));
00094 
00095 
00096 
00097 
00098 }<font class="comment">// Plcm::Plcm  //</font>
00099 <font class="comment">//----------------------------------------------------------------------------</font>
<a name="l00100"></a><a class="code" href="class_plcm.html#a2">00100</a>                <font class="keywordtype">void</font>  <a class="code" href="class_plcm.html#a2">Plcm::read</a>( <font class="keywordtype">void</font>  )
00101 <font class="comment">//</font>
00102 <font class="comment">// Reads input circuit data from database and runs parser.</font>
00103 <font class="comment">//</font>
00104 {
00105   <font class="keywordflow">if</font> (fromPartitioner == NULL)
00106   {
00107     <font class="keywordflow">if</font> (sdfreadallcir( SDFCIRALL ,cs(circuitName),cs(functionName),
00108           cs(libraryName)) == 0)
00109       <a class="code" href="usrlib.h.html#a12">usrErr</a>(<font class="stringliteral">"Plcm::Plcm"</font>,EINPDAT);
00110 
00111     givenCircuit = thiscir;
00112 
00113   }
00114   <font class="keywordflow">else</font>
00115     givenCircuit = fromPartitioner;
00116 
00117                 <font class="comment">// that's non partitioned circuit...</font>
00118                 <font class="comment">// don't do slicing.</font>
00119 
00120   <font class="keywordflow">if</font>(givenCircuit-&gt;cirinst-&gt;circuit-&gt;status != NULL &amp;&amp;
00121      (strstr(givenCircuit-&gt;cirinst-&gt;circuit-&gt;status-&gt;program,
00122        "mad_prim")!=NULL ||
00123       strstr(givenCircuit-&gt;cirinst-&gt;circuit-&gt;status-&gt;program,
00124        "libprim")!=NULL ))
00125   {
00126     slicingLayout=<font class="keyword">false</font>;
00127     globRouting=NULL;
00128     doTransAna=<font class="keyword">false</font>;
00129   }
00130 
00131 }<font class="comment">// Plcm::read  //</font>
00132 
00133 <font class="comment">//----------------------------------------------------------------------------</font>
<a name="l00134"></a><a class="code" href="class_plcm.html#a3">00134</a>                <font class="keywordtype">void</font>  <a class="code" href="class_plcm.html#a3">Plcm::prepare</a>( <font class="keywordtype">void</font>  )
00135 <font class="comment">//</font>
00136 <font class="comment">//</font>
00137 {
00138   <font class="keywordflow">if</font> (imageMap == NULL)
00139     <a class="code" href="usrlib.h.html#a12">usrErr</a>(<font class="stringliteral">"Plcm::prepare"</font>,EINPDAT);
00140                                    <font class="comment">// number of sectors in cluster can not</font>
00141                                    <font class="comment">// be greater then number of bits in</font>
00142                                    <font class="comment">// data of type clusterMapType</font>
00143   <font class="keywordflow">if</font>(thisImage.numsector &gt; 8* <font class="keyword">sizeof</font>(clusterMapType) )
00144     <a class="code" href="usrlib.h.html#a12">usrErr</a>(<font class="stringliteral">"Plcm::Plcm"</font>,ETASKIMP);
00145                                    <font class="comment">// if this occurs you should change typedef</font>
00146                                    <font class="comment">// definition for clusterMapType to data</font>
00147                                    <font class="comment">// of bigger size</font>
00148 
00149   clearFlags(givenCircuit);
00150 
00151   totalArea = readLayouts(givenCircuit);  <font class="comment">// also in each circuit-&gt;flag.l</font>
00152                                           <font class="comment">// leaves number of children</font>
00153 
00154 
00155 
00156                                    <font class="comment">// now create empty layout for our circuit</font>
00157 
00158   <font class="keywordflow">if</font> (NewLayout(layoutToBuild)==NULL)
00159     <a class="code" href="usrlib.h.html#a12">usrErr</a>(<font class="stringliteral">"Plcd"</font>,ENOTMEM);
00160 
00161   layoutToBuild-&gt;name=layoutName;
00162   layoutToBuild-&gt;layport=NULL;
00163   layoutToBuild-&gt;bbx[HOR]=0;    <font class="comment">// we don\'t know yet</font>
00164   layoutToBuild-&gt;bbx[VER]=0;
00165   layoutToBuild-&gt;off[HOR]=0;
00166   layoutToBuild-&gt;off[VER]=0;
00167   layoutToBuild-&gt;wire = NULL;
00168 
00169   layoutToBuild-&gt;linkcnt=1;
00170 
00171   <font class="keywordflow">if</font> (NewStatus(layoutToBuild-&gt;status)==NULL)
00172     <a class="code" href="usrlib.h.html#a12">usrErr</a>(<font class="stringliteral">"Plcd"</font>,ENOTMEM);
00173                 <font class="comment">// only temporary - just to find out</font>
00174                 <font class="comment">// slicing configuration</font>
00175 
00176 
00177   time(&amp;layoutToBuild-&gt;status-&gt;timestamp);
00178   layoutToBuild-&gt;status-&gt;author=cs(<font class="stringliteral">"Madonna"</font>);
00179   layoutToBuild-&gt;status-&gt;program=cs(<font class="stringliteral">"phil"</font>);
00180   layoutToBuild-&gt;next=NULL;
00181 
00182   SLICE *slPtr;
00183 
00184   <font class="keywordflow">if</font> ((slPtr=NewSlice(layoutToBuild-&gt;slice))==NULL)
00185     <a class="code" href="usrlib.h.html#a12">usrErr</a>(<font class="stringliteral">"Plcd"</font>,ENOTMEM);
00186 
00187   <font class="keywordflow">if</font> (slicingLayout)
00188   {
00189     <a class="code" href="class_cluster.html">Cluster</a> tmpcls = Cluster(0,0,thisImage.size[HOR],thisImage.size[VER]);
00190     <a class="code" href="class_window.html">Window</a>  tmpWindow(tmpcls,100,100);
00191     <font class="keywordtype">int</font> tmpInt;
00192 
00193     tmpWindow.getDiv(givenCircuit-&gt;name,&amp;slicesInHor,&amp;slicesInVer,&amp;tmpInt,&amp;tmpInt);
00194 
00195 
00196 
00197 
00198                 <font class="comment">// here building 2-level slicing structure</font>
00199 
00200     slPtr-&gt;ordination=VERTICAL;    
00201     slPtr-&gt;chld_type=SLICE_CHLD;
00202     slPtr-&gt;chld.slice=NULL; <font class="comment">// only this one will be used</font>
00203     slPtr-&gt;next=NULL;
00204     
00205     <font class="keywordflow">for</font>(<font class="keywordtype">int</font> i=0;i&lt;slicesInHor;i++)
00206     {
00207       SLICE *slvPtr;
00208       <font class="keywordflow">if</font> (NewSlice(slvPtr)==NULL)
00209     <a class="code" href="usrlib.h.html#a12">usrErr</a>(<font class="stringliteral">"Plcd"</font>,ENOTMEM);
00210                 <font class="comment">// vertical slices </font>
00211 
00212       slvPtr-&gt;ordination=HORIZONTAL; <font class="comment">// orietation is horizontal</font>
00213       slvPtr-&gt;chld_type=SLICE_CHLD;
00214       slvPtr-&gt;chld.slice=NULL;
00215       slvPtr-&gt;next=slPtr-&gt;chld.slice;
00216       slPtr-&gt;chld.slice=slvPtr;
00217 
00218                 <font class="comment">// now horizontal slices</font>
00219 
00220       <font class="keywordflow">for</font>(<font class="keywordtype">int</font> j=0;j&lt;slicesInVer;j++)
00221       {
00222     SLICE *slhPtr;
00223     <font class="keywordflow">if</font> (NewSlice(slhPtr)==NULL)
00224       <a class="code" href="usrlib.h.html#a12">usrErr</a>(<font class="stringliteral">"Plcd"</font>,ENOTMEM);
00225     slhPtr-&gt;ordination=CHAOS; <font class="comment">// these are CHAOS already</font>
00226     slhPtr-&gt;chld_type=LAYINST_CHLD;
00227     slhPtr-&gt;chld.layinst=NULL; <font class="comment">// here we\'ll later attach lay instances</font>
00228 
00229     slhPtr-&gt;next=slvPtr-&gt;chld.slice;
00230     slvPtr-&gt;chld.slice=slhPtr;
00231     
00232       }
00233     }
00234   }
00235   <font class="keywordflow">else</font>
00236   {
00237     slPtr-&gt;ordination=CHAOS;
00238     slPtr-&gt;chld_type=LAYINST_CHLD;
00239     slPtr-&gt;next=NULL;
00240     slPtr-&gt;chld.layinst=NULL;
00241     layInstancesList=NULL;
00242   }
00243 
00244 
00245 
00246 }<font class="comment">// Plcm::prepare  //</font>
00247 
00248 <font class="comment">//--------------------------------------------------------------</font>
<a name="l00249"></a><a class="code" href="class_plcm.html#a1">00249</a>                <a class="code" href="class_plcm.html#a1">Plcm::~Plcm</a>( <font class="keywordtype">void</font>  )
00250 <font class="comment">//</font>
00251 <font class="comment">//  Assumes that database will be closed externally.</font>
00252 <font class="comment">//</font>
00253 {
00254 
00255 <font class="comment">//  freeFlagItem(givenCircuit);</font>
00256 
00257   <font class="keyword">delete</font>( plane );
00258 
00259 
00260 }<font class="comment">// Plcm::~Plcm  //</font>
00261 
00262 <font class="comment">//--------------------------------------------------------------</font>
<a name="l00263"></a><a class="code" href="class_plcm.html#c8">00263</a>                <font class="keywordtype">int</font>  <a class="code" href="class_plcm.html#c8">Plcm::doPlacement</a>( CIRCUIT *circuitPtr,Boolean first  )
00264 <font class="comment">//</font>
00265 <font class="comment">// main placement routine. Returns 1 if placement impossible.</font>
00266 <font class="comment">//</font>
00267 {
00268   <font class="keywordflow">if</font> (circuitPtr-&gt;cirinst == NULL )
00269     <font class="keywordflow">return</font> 0;                        <font class="comment">// empty partition - nothing</font>
00270                                     <font class="comment">// to do</font>
00271   <font class="keywordflow">if</font>( circuitPtr-&gt;cirinst-&gt;circuit == NULL)
00272     <a class="code" href="usrlib.h.html#a12">usrErr</a>(<font class="stringliteral">"Plcm::doPlacement"</font>,EUNKNOW);
00273 
00274   <font class="keywordflow">if</font>(circuitPtr-&gt;cirinst-&gt;circuit-&gt;status  != NULL &amp;&amp;
00275      (strstr(circuitPtr-&gt;cirinst-&gt;circuit-&gt;status-&gt;program,"mad_prim")!=NULL ||
00276      strstr(circuitPtr-&gt;cirinst-&gt;circuit-&gt;status-&gt;program,"libprim")!=NULL) )
00277   {
00278                                 <font class="comment">// this circuit has only libprim children</font>
00279                                 <font class="comment">// so we can start placement</font>
00280 
00281                                 <font class="comment">// but ...</font>
00282                 <font class="comment">// before we start placing let\'s better sort the</font>
00283                 <font class="comment">// elements so that biggest one will come first</font>
00284 
00285     circuitPtr-&gt;cirinst=sortGroup(circuitPtr-&gt;cirinst);
00286 
00287     <font class="keywordflow">if</font> (! slicingLayout)
00288       layInstancesList=&amp;layoutToBuild-&gt;slice-&gt;chld.layinst;
00289       
00290     <font class="keywordflow">if</font> (placeGroup(circuitPtr-&gt;cirinst,*(<a class="code" href="class_window.html">Window</a> *)circuitPtr-&gt;flag.p))
00291       <font class="keywordflow">return</font> 1;
00292 
00293   }
00294   <font class="keywordflow">else</font>
00295   {
00296     CIRINST *ciPtr;
00297 
00298     <font class="keywordflow">if</font>(first &amp;&amp; slicingLayout)  <font class="comment">// we have to set slice info</font>
00299     {                       <font class="comment">// for each of slices</font>
00300       SLICE *thisSlice;
00301       
00302       <font class="keywordflow">for</font>(ciPtr=circuitPtr-&gt;cirinst;ciPtr!=NULL;ciPtr=ciPtr-&gt;next)
00303       {
00304     
00305     thisSlice=findSlice(ciPtr);
00306                 <font class="comment">// also we have to store slice info</font>
00307                 <font class="comment">// in the flag field of the slice</font>
00308     
00309     <a class="code" href="class__slice_info.html">SLICE_INFO</a> *tr_data = <font class="keyword">new</font> <a class="code" href="class__slice_info.html">SLICE_INFO</a>;
00310     <a class="code" href="class_window.html">Window</a> *wPtr=(<a class="code" href="class_window.html">Window</a>*)ciPtr-&gt;circuit-&gt;flag.p;
00311     tr_data-&gt;cX=wPtr-&gt;cX;
00312     tr_data-&gt;cY=wPtr-&gt;cY;
00313     tr_data-&gt;width=wPtr-&gt;width;
00314     tr_data-&gt;height=wPtr-&gt;high;
00315     tr_data-&gt;layerTrans=NULL;
00316     thisSlice-&gt;flag.p=(<font class="keywordtype">char</font>*)tr_data;
00317       }
00318     }
00319 
00320 
00321     <font class="keywordflow">for</font>(ciPtr=circuitPtr-&gt;cirinst;ciPtr!=NULL;ciPtr=ciPtr-&gt;next)
00322     {
00323       <font class="keywordflow">if</font> (first &amp;&amp; slicingLayout)
00324       {
00325     SLICE *sPtr = findSlice(ciPtr);
00326     layInstancesList=&amp;sPtr-&gt;chld.layinst;
00327       }
00328       <font class="keywordflow">else</font>
00329     <font class="keywordflow">if</font>(first)
00330       layInstancesList=&amp;layoutToBuild-&gt;slice-&gt;chld.layinst;
00331       <font class="keywordflow">if</font> ( doPlacement(ciPtr-&gt;circuit) )
00332     <font class="keywordflow">return</font> 1;
00333 
00334     }
00335   }
00336 <font class="preprocessor">#ifdef SLICE_DEBUG
</font>00337 <font class="preprocessor"></font>
00338   <font class="keywordflow">if</font> (first)
00339   {
00340     SLICE *slvPtr,*slhPtr;
00341 
00342     <font class="keywordflow">for</font>(slvPtr=layoutToBuild-&gt;slice-&gt;chld.slice;
00343     slvPtr!=NULL ;slvPtr=slvPtr-&gt;next)
00344       <font class="keywordflow">for</font>(slhPtr=slvPtr-&gt;chld.slice;
00345       slhPtr!=NULL ;slhPtr=slhPtr-&gt;next)
00346       {
00347     <a class="code" href="class__slice_info.html">SLICE_INFO</a>* siPtr=(<a class="code" href="class__slice_info.html">SLICE_INFO</a>*)slhPtr-&gt;flag.p;
00348     cout &lt;&lt; <font class="stringliteral">"Slice, ord "</font> &lt;&lt; slhPtr-&gt;ordination &lt;&lt; <font class="stringliteral">" ("</font>
00349          &lt;&lt; siPtr-&gt;cX &lt;&lt; <font class="stringliteral">","</font> &lt;&lt; siPtr-&gt;cY &lt;&lt; <font class="stringliteral">")"</font> &lt;&lt; endl;
00350     <font class="keywordflow">for</font>(LAYINST* liPtr=slhPtr-&gt;chld.layinst;liPtr!=NULL;liPtr=liPtr-&gt;next)
00351       cout &lt;&lt; liPtr-&gt;name &lt;&lt; <font class="stringliteral">","</font>;
00352     cout &lt;&lt; endl;
00353       }
00354 
00355     
00356   }
00357 <font class="preprocessor">#endif
</font>00358 <font class="preprocessor"></font>  <font class="keywordflow">return</font> 0;
00359 }<font class="comment">// Plcm::doPlacement  //</font>
00360 
00361 
00362 <font class="comment">//--------------------------------------------------------------</font>
<a name="l00363"></a><a class="code" href="class_plcm.html#c9">00363</a>   <font class="keywordtype">int</font>  <a class="code" href="class_plcm.html#c9">Plcm::placeGroup</a>(CIRINST *cInstList,<a class="code" href="class_window.html">Window</a> &amp;windowRef)
00364 <font class="comment">//</font>
00365 <font class="comment">// tries to place group of cells (libprim) in given window. Returns 1</font>
00366 <font class="comment">// if there's not enough place.</font>
00367 <font class="comment">//</font>
00368 {
00369   <font class="keywordtype">int</font> width=windowRef.width,
00370       high=windowRef.high,
00371       x=windowRef.cX,
00372       y=windowRef.cY;
00373 
00374   <font class="keywordtype">int</font> clustersInWindow=width*high,
00375       tooBigCellInGroup=0;
00376   CIRINST *ciPtr;
00377                 <font class="comment">// first lets find if we don't have a huge element in</font>
00378                 <font class="comment">// this group</font>
00379 
00380   <font class="keywordflow">for</font>(ciPtr=cInstList;ciPtr!=NULL;ciPtr=ciPtr-&gt;next)
00381   {
00382     LAYOUT *layPtr=ciPtr-&gt;circuit-&gt;layout;
00383 
00384     <font class="keywordflow">if</font>(strstr(layPtr-&gt;name,"Tmp_Cell_") == NULL ) <font class="comment">// this layouts are generraly ignored</font>
00385     {
00386       <a class="code" href="class_list.html">List</a>&amp; listRef=(<a class="code" href="class_list.html">List</a>&amp;)(*layPtr-&gt;flag.p);
00387       <a class="code" href="class_listiterator.html">ListIterator</a> lIter(listRef);
00388       <a class="code" href="class_pattern.html">Pattern</a>&amp; patRef=(<a class="code" href="class_pattern.html">Pattern</a>&amp;)(<a class="code" href="class_item.html">Item</a>&amp;)lIter;
00389 
00390       <font class="keywordflow">if</font>(patRef.<a class="code" href="class_box.html#a12">getItemsInBox</a>() &gt; 0.25*clustersInWindow || patRef.<a class="code" href="class_pattern.html#a8">isMacro</a>())
00391       {
00392     tooBigCellInGroup=1;
00393     <font class="keywordflow">break</font>;
00394       }
00395       
00396     }
00397   }
00398 
00399   <font class="keywordflow">if</font> (verboseMode)
00400   {
00401     cout &lt;&lt; <font class="stringliteral">"Placing group inside window ("</font> &lt;&lt; x &lt;&lt; <font class="stringliteral">","</font> &lt;&lt; y &lt;&lt; <font class="stringliteral">","</font> &lt;&lt; x+width
00402          &lt;&lt; <font class="stringliteral">","</font> &lt;&lt; y+high &lt;&lt; <font class="stringliteral">")"</font> &lt;&lt; endl;
00403   }
00404 
00405   <font class="keywordflow">if</font>(random_points &amp;&amp; ! tooBigCellInGroup)
00406   {
00407     <font class="keywordtype">int</font> security=0;
00408 
00409     <font class="keywordflow">for</font>(;security &lt; width*high; security++)
00410     {
00411       <font class="keywordtype">int</font> i = x+(rand()%width),
00412       j = y+(rand()%high);
00413 
00414       <a class="code" href="class_cluster.html">Cluster</a> cluster(i,j,thisImage.size[HOR],thisImage.size[VER]);
00415 
00416       <font class="keywordflow">if</font> (tryThisCluster(cInstList,cluster,(<a class="code" href="class_protarea.html">ProtArea</a>&amp;)NOITEM)) <font class="keywordflow">return</font> 0;
00417       <font class="comment">// all cells placed</font>
00418       <font class="comment">// end of job here</font>
00419     }
00420   }
00421   <font class="comment">// if still there's something to place or random placement disabled</font>
00422 
00423   <font class="comment">// because it may happen that there's no place for all elements from</font>
00424   <font class="comment">// this group in current window after trying it, surrounding area is also</font>
00425   <font class="comment">// tried (going through all rings of one window width around).</font>
00426 
00427   <font class="keywordtype">int</font> outerX1=x,
00428       outerY1=y,
00429       innerX1=windowRef.cX+width,
00430       innerY1=windowRef.cY+high,
00431       outerX2=innerX1,
00432       outerY2=innerY1,
00433       innerX2=x,
00434       innerY2=y,
00435       xMax = plane-&gt;cols*thisImage.size[HOR],
00436       yMax = plane-&gt;rows*thisImage.size[VER];
00437 
00438 
00439 
00440 
00441   <font class="keywordflow">for</font>(<font class="keywordtype">int</font> c=0;innerX1 &gt; 0 || innerX2 &lt; xMax || innerY1 &gt; 0 || innerY2 &lt; yMax;
00442                   c++,innerX1-=width,outerX1-=width,
00443                   innerX2+=width,outerX2+=width,
00444                   innerY1-=high,outerY1-=high,
00445                   innerY2+=high,outerY2+=high)
00446   {
00447     <font class="keywordflow">if</font>(c == 1 &amp;&amp; verboseMode)
00448     {
00449       cerr &lt;&lt; <font class="stringliteral">"\n There's too few place in "</font>
00450        &lt;&lt; <font class="stringliteral">"window at ("</font> &lt;&lt; x &lt;&lt; <font class="stringliteral">","</font> &lt;&lt; y &lt;&lt; <font class="stringliteral">") for this group of elements "</font>
00451        &lt;&lt; <font class="stringliteral">"\n searching in the surroundings for place for cell[s]:\n"</font>;
00452 
00453       <font class="keywordflow">for</font>(ciPtr=cInstList;ciPtr!=NULL;ciPtr=ciPtr-&gt;next)
00454       {
00455   <font class="keywordflow">if</font> ( ciPtr-&gt;flag.l == 0 )
00456     cerr &lt;&lt; <font class="stringliteral">"  "</font> &lt;&lt; ciPtr-&gt;name &lt;&lt; endl;
00457       }
00458 
00459     }
00460 
00461     <font class="keywordtype">int</font> i,j,
00462         iStart=outerX1,
00463         jStart=outerY1;
00464     <font class="keywordflow">if</font>(iStart &lt; 0)
00465       iStart=0;
00466     <font class="keywordflow">if</font>(jStart &lt; 0)
00467       jStart=0;
00468 
00469     <a class="code" href="class_cluster.html">Cluster</a>  lbc(iStart,jStart,thisImage.size[HOR],
00470          thisImage.size[VER]);
00471     <a class="code" href="class_protarea.html">ProtArea</a>  pa(lbc);
00472                 <font class="comment">// this is a so called "protected area"</font>
00473                 <font class="comment">// here you should try to place anymore</font>
00474 
00475     <font class="keywordflow">for</font>(i=iStart;i&lt;outerX2 &amp;&amp; i &lt; xMax;i++)
00476       <font class="keywordflow">for</font>(j=jStart;j&lt;outerY2 &amp;&amp; j&lt; yMax;j++)
00477   <font class="keywordflow">if</font>((i&gt;= outerX1 &amp;&amp; i &lt; innerX1 || i &gt;= innerX2 &amp;&amp; i &lt; outerX2 ||
00478      j &gt;= outerY1 &amp;&amp; j &lt; innerY1 || j &gt;= innerY2 &amp;&amp; j &lt; outerY2 ) &amp;&amp;
00479      ! pa.is(i,j))      <font class="comment">// do try this cluster if it's not within</font>
00480                 <font class="comment">// protected area</font>
00481   {
00482     <a class="code" href="class_cluster.html">Cluster</a> cluster(i,j,thisImage.size[HOR],thisImage.size[VER]);
00483 
00484     <font class="keywordflow">if</font> (tryThisCluster(cInstList,cluster,pa))
00485     {
00486       <font class="keywordflow">if</font> (c &gt;=1 &amp;&amp; verboseMode)
00487         cerr &lt;&lt; <font class="stringliteral">"\n  ====== SUCCESS ! ===== "</font> &lt;&lt; endl;
00488       <font class="keywordflow">return</font> 0; <font class="comment">// all cells placed</font>
00489                     <font class="comment">//  end of job here</font>
00490     }
00491 
00492   }
00493 
00494 
00495   }
00496 
00497   <font class="keywordflow">for</font>(ciPtr=cInstList;ciPtr!=NULL;ciPtr=ciPtr-&gt;next)
00498   {
00499     <font class="keywordflow">if</font> ( ciPtr-&gt;flag.l == 0 )
00500     {
00501       cerr &lt;&lt; <font class="stringliteral">" Can't place cell :"</font>;
00502       cerr &lt;&lt; ciPtr-&gt;name &lt;&lt; <font class="stringliteral">"  "</font>;
00503       cerr &lt;&lt; <font class="stringliteral">"in window at ("</font> &lt;&lt; x &lt;&lt; <font class="stringliteral">","</font> &lt;&lt; y &lt;&lt; <font class="stringliteral">")"</font>&lt;&lt; endl;
00504     }
00505   }
00506 
00507 <font class="comment">//  cerr &lt;&lt; "\n SORRY, apparently the magnification coefficient is too small. \n";</font>
00508 <font class="comment">//  cerr &lt;&lt; " Try to run program once again or change coefficient. \n";</font>
00509 
00510   cerr &lt;&lt; <font class="stringliteral">"\n Apparently the magnification coefficient is too small. \n"</font>;
00511   cerr &lt;&lt; <font class="stringliteral">" Let's try to run the algorithm for bigger magn. coefficient. \n"</font>;
00512 
00513   <font class="keywordflow">return</font> 1;
00514 
00515 }<font class="comment">// Plcm::placeGroup  //</font>
00516 
00517 
00518 <font class="comment">//--------------------------------------------------------------</font>
<a name="l00519"></a><a class="code" href="class_plcm.html#c10">00519</a>    Boolean   <a class="code" href="class_plcm.html#c10">Plcm::tryThisCluster</a>(CIRINST *ciPtr,<a class="code" href="class_cluster.html">Cluster</a> &amp;here,<a class="code" href="class_protarea.html">ProtArea</a>&amp; pa)
00520 <font class="comment">//</font>
00521 <font class="comment">// tries to place group of cells in this cluster. Translation point</font>
00522 <font class="comment">// in bottom-left corner of cluster. Return true if all cell placed</font>
00523 <font class="comment">// here. Updates "protected area".</font>
00524 {
00525   Boolean successFlag = <font class="keyword">true</font>;
00526   
00527   <font class="keywordflow">for</font>(;ciPtr != NULL;ciPtr=ciPtr-&gt;next)
00528     <font class="keywordflow">if</font>(ciPtr-&gt;flag.l == 0)         <font class="comment">//still not placed</font>
00529     {
00530       <font class="keywordflow">for</font>(LAYOUT *lPtr=ciPtr-&gt;circuit-&gt;layout;lPtr!=NULL;lPtr=lPtr-&gt;next)
00531       {
00532     <font class="keywordflow">if</font>(strstr(lPtr-&gt;name,"Tmp_Cell_")==NULL ) <font class="comment">// don't consider </font>
00533                           <font class="comment">// nelsis's tmp cells</font>
00534     {
00535       <a class="code" href="class_pattern.html">Pattern</a>&amp; good=tryThisCellHere(lPtr,here,pa);
00536       
00537       <font class="keywordflow">if</font>(good != NOITEM)      <font class="comment">// we can place this cell here</font>
00538       {
00539         placeOneCell(ciPtr,lPtr,good,here,pa);
00540         <font class="keywordflow">break</font>;          <font class="comment">// only one layout should be selected</font>
00541       }
00542       <font class="keywordflow">else</font>
00543         successFlag = <font class="keyword">false</font>;    <font class="comment">// to indicate that at least one cell still</font>
00544       <font class="comment">// not placed</font>
00545       
00546     }
00547       }
00548       
00549     }
00550   <font class="keywordflow">return</font> successFlag;
00551   
00552 }<font class="comment">// Plcm::tryThisCluster  //</font>
00553 
00554 <font class="comment">//--------------------------------------------------------------</font>
<a name="l00555"></a><a class="code" href="class_plcm.html#c11">00555</a> <a class="code" href="class_pattern.html">Pattern</a>&amp; <a class="code" href="class_plcm.html#c11">Plcm::tryThisCellHere</a>(LAYOUT *lPtr,<a class="code" href="class_cluster.html">Cluster</a> &amp;here,<a class="code" href="class_protarea.html">ProtArea</a>&amp; pa )
00556 <font class="comment">//</font>
00557 <font class="comment">// Tries to place this layout here by trying all patterns</font>
00558 <font class="comment">// and checking if obtained points belong to still free sectors</font>
00559 <font class="comment">// Returns ref to pattern on success and NOITEM if failed.</font>
00560 <font class="comment">// Also checks if conflict critical points exist.</font>
00561 {
00562   <a class="code" href="class_list.html">List</a> &amp;patListRef=(<a class="code" href="class_list.html">List</a>&amp;)(*lPtr-&gt;flag.p);
00563   <font class="keywordtype">int</font> x = here.cX,
00564       y = here.cY;
00565 
00566 
00567   <font class="keywordflow">for</font>(<a class="code" href="class_listiterator.html">ListIterator</a> patIter(patListRef);(<a class="code" href="class_item.html">Item</a>&amp;)patIter != NOITEM;patIter++)
00568   {
00569     <a class="code" href="class_pattern.html">Pattern</a> &amp;patternRef = (<a class="code" href="class_pattern.html">Pattern</a>&amp;)(<a class="code" href="class_item.html">Item</a>&amp;)patIter;
00570 
00571     <font class="keywordflow">if</font>(!patternRef.<a class="code" href="class_pattern.html#a8">isMacro</a>())
00572     {
00573       <a class="code" href="class_listiterator.html">ListIterator</a> cluIter(patternRef);
00574       
00575       <font class="keywordflow">for</font>(;(<a class="code" href="class_item.html">Item</a>&amp;)cluIter != NOITEM;cluIter++)
00576       {
00577     <a class="code" href="class_clst.html">Clst</a> &amp;cluRef = (<a class="code" href="class_clst.html">Clst</a>&amp;)(<a class="code" href="class_item.html">Item</a>&amp;)cluIter;
00578     
00579     
00580         <font class="comment">/* I have changed clusterMapType(cluRef) into cluRef.pattern
</font>00581 <font class="comment">           because it appeared that the first one did not always return
</font>00582 <font class="comment">           the correct value when gcc is used.  AvG 17081999 */</font>
00583 
00584     <font class="keywordflow">if</font> ( cluRef.pattern &amp; plane-&gt;getPattern(x+cluRef.cX,y+cluRef.cY) )
00585                                     <font class="comment">// if even one of sectors</font>
00586                                     <font class="comment">// is already accupied then</font>
00587                                     <font class="comment">// we must try another pattern</font>
00588       <font class="keywordflow">break</font>;
00589     <a class="code" href="class_list.html">List</a> &amp;criList= plane-&gt;getCriticals(x+cluRef.cX,y+cluRef.cY);
00590     
00591     <font class="keywordflow">if</font> ( criList != NOITEM &amp;&amp;   criList &amp; cluRef )
00592                                     <font class="comment">// also compares lists of critical</font>
00593                                     <font class="comment">// points. For details  look</font>
00594                                     <font class="comment">// operator &amp; (List&amp;,List&amp;)</font>
00595       <font class="keywordflow">break</font>;
00596       }
00597       <font class="keywordflow">if</font> ((<a class="code" href="class_item.html">Item</a>&amp;)cluIter == NOITEM )   <font class="comment">// no sectors in common at all- success!</font>
00598     <font class="keywordflow">return</font> patternRef;
00599       
00600     }
00601     <font class="keywordflow">else</font>            <font class="comment">// is a macro</font>
00602     {
00603 
00604       Boolean failed=<font class="keyword">false</font>;
00605       <font class="keywordflow">for</font>(<font class="keywordtype">int</font> i=0;i&lt;patternRef.<a class="code" href="class_pattern.html#a9">getHor</a>();i++)
00606     <font class="keywordflow">for</font>(<font class="keywordtype">int</font> j=0;j&lt;patternRef.<a class="code" href="class_pattern.html#a10">getVer</a>();j++)
00607       <font class="keywordflow">if</font> (plane-&gt;getPattern(x+i,y+j)!=0) <font class="comment">// it's occupied</font>
00608       {
00609         failed=<font class="keyword">true</font>;
00610         pa.update(x+i,y+j);
00611         <font class="keywordflow">break</font>;
00612       }
00613       <font class="keywordflow">if</font>(!failed)
00614     <font class="keywordflow">return</font> patternRef;
00615     }
00616   }
00617   <font class="keywordflow">return</font> (<a class="code" href="class_pattern.html">Pattern</a>&amp;)NOITEM;  <font class="comment">// Placement of this cell in this cluster</font>
00618                               <font class="comment">// impossible</font>
00619 
00620 }<font class="comment">// Plcm::tryThisCellHere  //</font>
00621 
00622 <font class="comment">//--------------------------------------------------------------</font>
<a name="l00623"></a><a class="code" href="class_plcm.html#c12">00623</a> <font class="keywordtype">void</font>  <a class="code" href="class_plcm.html#c12">Plcm::placeOneCell</a>(CIRINST *ciPtr,LAYOUT *lPtr,<a class="code" href="class_pattern.html">Pattern</a> &amp;patRef,
00624                          <a class="code" href="class_cluster.html">Cluster</a> &amp;here,<a class="code" href="class_protarea.html">ProtArea</a>&amp; pa)
00625 <font class="comment">//</font>
00626 <font class="comment">// Marks new sectors in plane and adds new layout instance to layout</font>
00627 <font class="comment">// being generated. Updates protected area too.</font>
00628 <font class="comment">//</font>
00629 {
00630   <font class="keywordtype">int</font>  x = here.cX,
00631        y = here.cY,
00632        minx=x,
00633        miny=y;
00634 
00635                 <font class="comment">// first we have to find out what is the real</font>
00636                 <font class="comment">// offset</font>
00637 
00638                 <font class="comment">// now marking placement plane</font>
00639 
00640   <font class="keywordflow">if</font>(!patRef.<a class="code" href="class_pattern.html#a8">isMacro</a>())     <font class="comment">// ordinary cell</font>
00641   {
00642     <font class="keywordflow">for</font>(<a class="code" href="class_listiterator.html">ListIterator</a> cluIter(patRef);(<a class="code" href="class_item.html">Item</a>&amp;)cluIter != NOITEM;cluIter++)
00643     {
00644       <a class="code" href="class_clst.html">Clst</a> &amp;cluRef = (<a class="code" href="class_clst.html">Clst</a>&amp;)(<a class="code" href="class_item.html">Item</a>&amp;)cluIter;
00645       
00646       plane-&gt;mark(x+cluRef.cX,y+cluRef.cY,cluRef.pattern,cluRef.criticalPoints);
00647       
00648       <font class="keywordflow">if</font> (minx &gt; x+cluRef.cX)
00649     minx=x+cluRef.cX;
00650       <font class="keywordflow">if</font> (miny &gt; y+cluRef.cY)
00651     miny=y+cluRef.cY;
00652     }
00653   }
00654   <font class="keywordflow">else</font>              <font class="comment">// that's a macro</font>
00655   {
00656     <font class="keywordflow">if</font>(verboseMode)
00657       cout &lt;&lt; <font class="stringliteral">"Placing "</font> &lt;&lt; ciPtr-&gt;name &lt;&lt; <font class="stringliteral">" as a macro."</font> &lt;&lt; endl;
00658 
00659     clusterMapType  pat=0;
00660     pat=~pat;           <font class="comment">// this sets all our bits to 1</font>
00661     <a class="code" href="class_list.html">List</a>  em;
00662     <font class="keywordflow">for</font>(<font class="keywordtype">int</font> i=0;i&lt;patRef.<a class="code" href="class_pattern.html#a9">getHor</a>();i++)
00663       <font class="keywordflow">for</font>(<font class="keywordtype">int</font> j=0;j&lt;patRef.<a class="code" href="class_pattern.html#a10">getVer</a>();j++)
00664     plane-&gt;mark(x+i,y+j,pat,em);    
00665     pa.update(x+patRef.<a class="code" href="class_pattern.html#a9">getHor</a>(),y+patRef.<a class="code" href="class_pattern.html#a10">getVer</a>()); <font class="comment">// the highest point</font>
00666   }
00667     
00668                             <font class="comment">// now we should  add new layout</font>
00669                             <font class="comment">// instance</font>
00670   LAYINST *liPtr;
00671 
00672   <font class="keywordflow">if</font> (NewLayinst(liPtr)== NULL)
00673     <a class="code" href="usrlib.h.html#a12">usrErr</a>(<font class="stringliteral">"Plcm::placeOneCell"</font>,ENOTMEM);
00674 
00675   liPtr-&gt;name=cs(ciPtr-&gt;name);
00676   liPtr-&gt;layout=lPtr;
00677 
00678   liPtr-&gt;flag.s[0]=minx;       <font class="comment">// needed during compaction</font>
00679   liPtr-&gt;flag.s[1]=miny;
00680 
00681   memcpy(liPtr-&gt;mtx,(<font class="keywordtype">short</font>*)patRef,6*<font class="keyword">sizeof</font>(<font class="keywordtype">short</font>));
00682 
00683                 <font class="comment">// this offset is composed of three parts:</font>
00684                 <font class="comment">// 1. real coeficient for transformation</font>
00685                 <font class="comment">// 2. offset to move it back to (0,0) after trans.</font>
00686                 <font class="comment">// 3. offset within placement plane</font>
00687 
00688 <font class="comment">//  liPtr-&gt;mtx[B1]+=here.x-coX;</font>
00689 <font class="comment">//  liPtr-&gt;mtx[B2]+=here.y-coY;</font>
00690 
00691   liPtr-&gt;mtx[B1]+=here.x;
00692   liPtr-&gt;mtx[B2]+=here.y;
00693   Boolean placed=<font class="keyword">false</font>;
00694     SLICE* slvPtr,*slhPtr;
00695     <font class="keywordtype">int</font> i,j;
00696 
00697   <font class="keywordflow">if</font>(slicingLayout )<font class="comment">// we have to find out which slice it</font>
00698   {             <font class="comment">// actually is..</font>
00699     
00700     <font class="keywordflow">for</font>(i=0,slvPtr=layoutToBuild-&gt;slice-&gt;chld.slice;
00701     slvPtr!=NULL &amp;&amp; i&lt;slicesInHor;i++,slvPtr=slvPtr-&gt;next)
00702       <font class="keywordflow">for</font>(j=0,slhPtr=slvPtr-&gt;chld.slice;
00703           slhPtr!=NULL &amp;&amp; j&lt;slicesInVer;j++,slhPtr=slhPtr-&gt;next)
00704       {
00705     <a class="code" href="class__slice_info.html">SLICE_INFO</a>* siPtr=(<a class="code" href="class__slice_info.html">SLICE_INFO</a>*)slhPtr-&gt;flag.p;
00706     <font class="keywordflow">if</font>(siPtr-&gt;cX &lt;= here.cX &amp;&amp; here.cX &lt;siPtr-&gt;cX+siPtr-&gt;width &amp;&amp;
00707        siPtr-&gt;cY &lt;= here.cY &amp;&amp; here.cY &lt;siPtr-&gt;cY+siPtr-&gt;height )
00708     {
00709       liPtr-&gt;next=slhPtr-&gt;chld.layinst;
00710       slhPtr-&gt;chld.layinst=liPtr;
00711       placed=<font class="keyword">true</font>;
00712       <font class="keywordflow">break</font>;
00713     }
00714       }
00715     <font class="keywordflow">if</font>(!placed)         <font class="comment">// this may happen when we have </font>
00716     {               <font class="comment">// channels (windows are smaller)</font>
00717       liPtr-&gt;next=*layInstancesList;
00718       *layInstancesList=liPtr; 
00719     }
00720   }
00721   <font class="keywordflow">else</font>
00722   {
00723     liPtr-&gt;next=*layInstancesList;
00724     *layInstancesList=liPtr; 
00725   }
00726 
00727 
00728   liPtr-&gt;layout-&gt;linkcnt++;
00729 
00730   <font class="keywordflow">if</font>(verboseMode)
00731   {
00732     cout &lt;&lt; <font class="stringliteral">"Cell : "</font> &lt;&lt; ciPtr-&gt;name &lt;&lt; <font class="stringliteral">" placed.\n"</font>;
00733   }
00734                             <font class="comment">// now we only have to mark this one</font>
00735                             <font class="comment">// as already placed</font>
00736   ciPtr-&gt;flag.l=1;
00737 
00738 
00739 }<font class="comment">// Plcm::placeOneCell  //</font>
00740 
00741 <font class="comment">//--------------------------------------------------------------</font>
<a name="l00742"></a><a class="code" href="class_plcm.html#c6">00742</a> <font class="keywordtype">void</font>  <a class="code" href="class_plcm.html#c6">Plcm::freeFlagItem1</a>(CIRCUIT *cPtr)
00743 <font class="comment">//</font>
00744 <font class="comment">// This routine should free all :</font>
00745 <font class="comment">// -Pattern's attached to each libprim layout</font>
00746 {
00747   <font class="keywordflow">if</font>( cPtr-&gt;status != NULL &amp;&amp;
00748       (strstr(cPtr-&gt;status-&gt;program,"mad_prim")!= NULL ||
00749        strstr(cPtr-&gt;status-&gt;program,"libprim")!= NULL) &amp;&amp;
00750       cPtr-&gt;layout != NULL )
00751   {
00752     <font class="keywordflow">for</font>(LAYOUT *lPtr=cPtr-&gt;layout;lPtr!=NULL;lPtr=lPtr-&gt;next)
00753       <font class="keywordflow">if</font>(strstr(lPtr-&gt;name,"Tmp_Cell_")==NULL ) <font class="comment">// don't consider </font>
00754                                             <font class="comment">// nelsis's tmp cells</font>
00755       {
00756 
00757     <font class="keyword">delete</font> (<a class="code" href="class_list.html">List</a>*)lPtr-&gt;flag.p;
00758       }
00759     cPtr-&gt;layout-&gt;flag.p=NULL;             <font class="comment">// to be sure that we will</font>
00760                                            <font class="comment">// not free the same thing</font>
00761                                            <font class="comment">// twice</font>
00762 
00763     <font class="keywordflow">return</font>;
00764   }
00765   <font class="keywordflow">for</font>(CIRINST *ciPtr=cPtr-&gt;cirinst;ciPtr!=NULL;ciPtr=ciPtr-&gt;next)
00766   {
00767     freeFlagItem1(ciPtr-&gt;circuit);
00768   }
00769 
00770 
00771 }<font class="comment">// Plcm::freeFlagItem1  //</font>
00772 
00773 <font class="comment">//--------------------------------------------------------------</font>
<a name="l00774"></a><a class="code" href="class_plcm.html#c7">00774</a>                <font class="keywordtype">void</font>  <a class="code" href="class_plcm.html#c7">Plcm::freeFlagItem2</a>(CIRCUIT *cPtr)
00775 <font class="comment">//</font>
00776 <font class="comment">// This routine should free all :</font>
00777 <font class="comment">// -Window's attached to each circuit with has cirinst of libprim type</font>
00778 {
00779   <font class="keyword">delete</font> (<a class="code" href="class_window.html">Window</a>*)cPtr-&gt;flag.p;
00780 
00781   <font class="keywordflow">if</font>( cPtr-&gt;cirinst==NULL || 
00782       (cPtr-&gt;cirinst-&gt;circuit-&gt;status != NULL &amp;&amp;
00783        (strstr(cPtr-&gt;cirinst-&gt;circuit-&gt;status-&gt;program,"mad_prim")!=NULL ||
00784     strstr(cPtr-&gt;cirinst-&gt;circuit-&gt;status-&gt;program,"libprim")!=NULL ))  ) 
00785   {
00786     <font class="keywordflow">return</font>;     <font class="comment">// this window wasn\'t devided</font>
00787   }
00788   <font class="keywordflow">for</font>(CIRINST *ciPtr=cPtr-&gt;cirinst;ciPtr!=NULL;ciPtr=ciPtr-&gt;next)
00789   {
00790     freeFlagItem2(ciPtr-&gt;circuit);
00791   }
00792 
00793 
00794 }<font class="comment">// Plcm::freeFlagItem2  //</font>
00795 
00796 <font class="comment">//--------------------------------------------------------------</font>
<a name="l00797"></a><a class="code" href="class_plcm.html#a9">00797</a>                <font class="keywordtype">void</font>  <a class="code" href="class_plcm.html#a9">Plcm::write</a>(CIRCUIT *cirPtr,Boolean doWrite )
00798 <font class="comment">//</font>
00799 <font class="comment">// Writes created layout back to database.</font>
00800 <font class="comment">// In the database we have two circuits : artificial created by partitioner</font>
00801 <font class="comment">// called name_p and normal circuit name .We have to attach our new layout</font>
00802 <font class="comment">// to this second one.</font>
00803 <font class="comment">// If we're in "in core partitioning" then cirPtr must contains ptr</font>
00804 <font class="comment">// to the real circuit to which we have to attach this new layout.</font>
00805 <font class="comment">//</font>
00806 {
00807   <font class="keywordflow">if</font>(slicingLayout)
00808     removeEmptySlices();
00809 
00810   
00811   <font class="comment">// now we must change circuit name to indicate that it is already</font>
00812   <font class="comment">// not partitioned</font>
00813 
00814   <font class="keywordflow">if</font>(fromPartitioner == NULL)
00815   {
00816     <font class="keywordtype">char</font> *sPtr=strdup(givenCircuit-&gt;name);
00817 
00818     <font class="keywordtype">char</font> *tokenPtr = strstr(sPtr,<font class="stringliteral">"_p"</font>);
00819 
00820     <font class="keywordflow">if</font> (tokenPtr == NULL)
00821     {
00822       cerr &lt;&lt; <font class="stringliteral">"\nWas it the right kind of circuit ? "</font> &lt;&lt; endl;
00823       <a class="code" href="usrlib.h.html#a12">usrErr</a>(<font class="stringliteral">"Plcm::write"</font>,EUNKNOW);
00824     }
00825     *tokenPtr=<font class="charliteral">'\0'</font>;   <font class="comment">// truncating last _p characters</font>
00826 
00827     sPtr=cs(sPtr);
00828 
00829     <font class="keywordflow">if</font> (sdfreadallcir( SDFCIRSTAT ,sPtr,cs(functionName),
00830           cs(libraryName)) == 0)
00831       <a class="code" href="usrlib.h.html#a12">usrErr</a>(<font class="stringliteral">"Plcm::write"</font>,EUNKNOW);
00832 
00833     thiscir-&gt;layout=layoutToBuild;
00834     layoutToBuild-&gt;circuit=thiscir;
00835 
00836     <font class="keywordflow">if</font>(doWrite)
00837       sdfwritelay(SDFLAYALL,layoutToBuild);
00838 
00839   }
00840   <font class="keywordflow">else</font>
00841   {
00842     cirPtr-&gt;layout=layoutToBuild;
00843     layoutToBuild-&gt;circuit=cirPtr;
00844 
00845     <font class="keywordflow">if</font>(doWrite)
00846       sdfwritelay(SDFLAYALL,layoutToBuild);
00847 
00848   }
00849 
00850 }<font class="comment">// Plcm::write  //</font>
00851 
00852 
00853 
00854 
00855 
00856 <font class="comment">//----------------------------------------------------------------------------</font>
00857                CIRINSTPTR  <a class="code" href="class_plcm.html#c13">Plcm::sortGroup</a>(CIRINSTPTR cList)
00858 <font class="comment">//</font>
00859 <font class="comment">// This routine sorts the elements on the list "cList" in decreasing order</font>
00860 <font class="comment">// Returns the pointer to the new head. I\'m afraid this algorithm is half quadratic </font>
00861 <font class="comment">// however we don\'t expect the list to be too long.</font>
00862 {
00863   CIRINST *head = NULL,
00864           *begin = cList,
00865           *current,
00866           *previous,
00867           *oneBefore,
00868           *smallest;
00869   <font class="keywordtype">int</font> a;
00870 
00871   <font class="keywordflow">while</font>(begin != NULL)      <font class="comment">// until all cells processed</font>
00872   {
00873                 <font class="comment">// first let\'s find the smallest left</font>
00874     <font class="keywordtype">int</font> size=MAXINT;
00875     previous=NULL;
00876 
00877     <font class="keywordflow">for</font>(current=begin;current!=NULL;previous=current,current=current-&gt;next)
00878     {
00879       LAYOUT *lay=current-&gt;circuit-&gt;layout;
00880       <font class="keywordflow">if</font>((a=lay-&gt;bbx[HOR]*lay-&gt;bbx[VER]) &lt; size)
00881       {
00882     size=a;
00883     smallest=current;
00884     oneBefore=previous;
00885       }
00886     }
00887                 <font class="comment">// now let\'s remove it from the list</font>
00888     <font class="keywordflow">if</font>(oneBefore != NULL)
00889       oneBefore-&gt;next=smallest-&gt;next;
00890     <font class="keywordflow">else</font>
00891       begin=smallest-&gt;next;
00892                 <font class="comment">// finally we only have to add it to our </font>
00893                 <font class="comment">// new sorted list</font>
00894     previous=head;
00895     head=smallest;
00896     smallest-&gt;next=previous;
00897   }
00898   <font class="keywordflow">return</font> head;
00899 
00900 }<font class="comment">// Plcm::sortGroup  //</font>
00901 
00902 
00903 <font class="comment">//----------------------------------------------------------------------------</font>
<a name="l00904"></a><a class="code" href="class_plcm.html#a4">00904</a> <font class="keywordtype">void</font>  <a class="code" href="class_plcm.html#a4">Plcm::createPlane</a>(<font class="keywordtype">int</font> hor,<font class="keywordtype">int</font> ver )
00905 <font class="comment">//</font>
00906 <font class="comment">// This routine creates placement plane of the right size and assigns</font>
00907 <font class="comment">// window to groups </font>
00908 {
00909 
00910 
00911                 <font class="comment">// first adjust sizes to be multiplication</font>
00912                 <font class="comment">// of basic cell</font>
00913 
00914   <font class="keywordflow">if</font>(hor % thisImage.size[HOR] != 0)
00915   {
00916     hor=(hor / thisImage.size[HOR] +1) *
00917                              thisImage.size[HOR];
00918   }
00919   <font class="keywordflow">if</font>(ver % thisImage.size[VER] != 0)
00920   {
00921     ver=(ver / thisImage.size[VER] +1) *
00922                              thisImage.size[VER];
00923   }
00924                 <font class="comment">// this is the size of our chip</font>
00925                 <font class="comment">// as adjusted by partitioner</font>
00926 
00927   <font class="keywordtype">int</font>  clustersInHor = hor / thisImage.size[HOR] ;
00928   <font class="keywordtype">int</font>  clustersInVer = ver / thisImage.size[VER] ;
00929 
00930   clearFlags(givenCircuit);
00931                                          <font class="comment">// clean two kinds of flags - used for</font>
00932                      <font class="comment">// windows and ones used for marking </font>
00933                      <font class="comment">// placed cells</font>
00934 
00935   <a class="code" href="class_cluster.html">Cluster</a> cls = Cluster(0,0,thisImage.size[HOR],thisImage.size[VER]);
00936 
00937   <font class="keywordflow">if</font> (globRouting != NULL)  <font class="comment">// we have to reserve some space for </font>
00938                 <font class="comment">// routing channels</font>
00939   {
00940     <a class="code" href="class_window.html">Window</a> tempW(cls,clustersInHor,clustersInVer);
00941 
00942     <font class="keywordtype">int</font> c,r,w,h,i;
00943     
00944     tempW.<a class="code" href="class_window.html#a4">getDiv</a>(givenCircuit-&gt;name,&amp;c,&amp;r,&amp;w,&amp;h);
00945     <font class="keywordflow">for</font>(i=0;i&lt;c-1;i++)
00946       clustersInHor+=globRouting-&gt;vertical_channels[i].ncells;
00947     <font class="keywordflow">for</font>(i=0;i&lt;r-1;i++)
00948       clustersInVer+=globRouting-&gt;horizontal_channels[i].ncells;
00949   }
00950 
00951 
00952   <a class="code" href="class_window.html">Window</a>  *bigWindow =  <font class="keyword">new</font> Window(cls,clustersInHor,clustersInVer);
00953 
00954   givenCircuit-&gt;flag.p=(<font class="keywordtype">char</font>*)bigWindow; 
00955 
00956 
00957   plane = <font class="keyword">new</font> Plane(clustersInVer,clustersInHor);
00958 
00959 
00960 
00961 
00962   makeWindows(givenCircuit,<a class="code" href="sea.h.html#a3">Boolean</a>(globRouting!=NULL)); 
00963                                 <font class="comment">// true - means add channels</font>
00964 
00965                 <font class="comment">// and check if this is a cleaned layout</font>
00966                 <font class="comment">// (all layout instances removed)</font>
00967   <font class="keywordflow">if</font>(layInstancesList != NULL)
00968     <a class="code" href="usrlib.h.html#a12">usrErr</a>(<font class="stringliteral">"Plcm"</font>,EUNKNOW);
00969 
00970                 <font class="comment">// that\'s all, I suppose ...</font>
00971 
00972    
00973 }<font class="comment">// Plcm::createPlane  //</font>
00974 
00975 <font class="comment">//----------------------------------------------------------------------------</font>
<a name="l00976"></a><a class="code" href="class_plcm.html#a7">00976</a> <font class="keywordtype">void</font> <a class="code" href="class_plcm.html#a7">Plcm::recover</a>(<font class="keywordtype">void</font>)
00977 <font class="comment">//</font>
00978 <font class="comment">// This routine removes all layout instances that have been placed, placement plane </font>
00979 <font class="comment">// and windows, so that placement can be started again for the same circuit.</font>
00980 {
00981   <font class="keywordtype">int</font> i,j;
00982 
00983   <font class="keywordflow">if</font>(slicingLayout)
00984   {
00985     SLICE* slvPtr,*slhPtr;
00986 
00987     <font class="keywordflow">for</font>(i=0,slvPtr=layoutToBuild-&gt;slice-&gt;chld.slice;
00988     slvPtr!=NULL &amp;&amp; i&lt;slicesInHor;i++,slvPtr=slvPtr-&gt;next)
00989       <font class="keywordflow">for</font>(j=0,slhPtr=slvPtr-&gt;chld.slice;
00990           slhPtr!=NULL &amp;&amp; j&lt;slicesInVer;j++,slhPtr=slhPtr-&gt;next)
00991       {
00992     <font class="keywordflow">for</font>(LAYINSTPTR lPtr=slhPtr-&gt;chld.layinst;lPtr != NULL;)
00993     {
00994       LAYINSTPTR tmp=lPtr;
00995       
00996       lPtr=lPtr-&gt;next;
00997       FreeLayinst(tmp);     <font class="comment">// and get rid of it</font>
00998     }
00999     slhPtr-&gt;chld.layinst=NULL;
01000 
01001                 <font class="comment">// also delete SLICE_INFO structures</font>
01002 
01003     <a class="code" href="class__slice_info.html">SLICE_INFO</a>* tdPtr=(<a class="code" href="class__slice_info.html">SLICE_INFO</a>*)slhPtr-&gt;flag.p;
01004     <font class="keyword">delete</font> tdPtr-&gt;layerTrans;
01005     <font class="keyword">delete</font> tdPtr;
01006     slhPtr-&gt;flag.p=NULL;
01007       }
01008   }
01009   <font class="keywordflow">else</font>
01010   {
01011     <font class="keywordflow">for</font>(LAYINSTPTR lPtr=*layInstancesList;lPtr != NULL;)
01012     {
01013       LAYINSTPTR tmp=lPtr;
01014       
01015       lPtr=lPtr-&gt;next;
01016       FreeLayinst(tmp);     <font class="comment">// and get rid of it</font>
01017     }
01018     *layInstancesList=NULL;
01019   }
01020   layInstancesList=NULL;
01021 
01022   <font class="keyword">delete</font> plane;
01023 
01024   freeFlagItem2(givenCircuit);  <font class="comment">// Let\'s remove only windows</font>
01025   
01026 }<font class="comment">// Plcm::recover  //</font>
01027 
01028 
01029 <font class="comment">//----------------------------------------------------------------------------</font>
<a name="l01030"></a><a class="code" href="class_plcm.html#a6">01030</a> <font class="keywordtype">void</font> <a class="code" href="class_plcm.html#a6">Plcm::setBbx</a>(<font class="keywordtype">void</font>)
01031 <font class="comment">//</font>
01032 <font class="comment">//</font>
01033 {
01034   <font class="keywordtype">int</font> x,y;
01035   
01036   plane-&gt;getEffSize(x,y);
01037   
01038   layoutToBuild-&gt;bbx[HOR]=x*thisImage.size[HOR]+thisImage.overlap[HOR]; 
01039   layoutToBuild-&gt;bbx[VER]=y*thisImage.size[VER]+thisImage.overlap[VER];
01040   
01041 }<font class="comment">// Plcm::setBbx  //</font>
01042 
01043 
01044 <font class="comment">//----------------------------------------------------------------------------</font>
<a name="l01045"></a><a class="code" href="class_plcm.html#c23">01045</a> <font class="keywordtype">int</font>* <a class="code" href="class_plcm.html#c23">Plcm::calcTransp</a>(SLICE* theSlice)
01046 <font class="comment">//</font>
01047 <font class="comment">// This function creates an array with each position saying what are </font>
01048 <font class="comment">// the free numbers of tracks for each layer</font>
01049 <font class="comment">// for this slice. If the layer 1 has orietation horizontal then we will </font>
01050 <font class="comment">// get in array[1] number of horizontal wires that could through  this slice.</font>
01051 <font class="comment">// The size of the slices in clusters have been previously saved in flag </font>
01052 <font class="comment">// field of this slice (the whole Window object).  </font>
01053 {
01054                 <font class="comment">// slice size in grid points</font>
01055 
01056   <a class="code" href="class__slice_info.html">SLICE_INFO</a>* sliceInfo = (<a class="code" href="class__slice_info.html">SLICE_INFO</a>*)theSlice-&gt;flag.p;
01057   <font class="keywordtype">int</font> sliceWidth=sliceInfo-&gt;width*thisImage.size[HOR],
01058       sliceHeight=sliceInfo-&gt;height*thisImage.size[VER],
01059       cXstart=sliceInfo-&gt;cX,
01060       cYstart=sliceInfo-&gt;cY;
01061 
01062                 <font class="comment">// first let\'s allocate the array</font>
01063 
01064   <font class="keywordtype">int</font> *theArray= <font class="keyword">new</font> <font class="keywordtype">int</font> [thisImage.numlayers];
01065 
01066                 <font class="comment">// ... and temporary arrays</font>
01067 
01068   <a class="code" href="class_transparency.html">Transparency</a>* trTable= <font class="keyword">new</font> <a class="code" href="class_transparency.html">Transparency</a>[thisImage.numlayers];
01069 
01070   <font class="keywordflow">for</font>(<font class="keywordtype">int</font> i=0;i&lt;thisImage.numlayers;i++)
01071     trTable[i]=Transparency(sliceWidth,sliceHeight);
01072 
01073   <font class="keywordflow">if</font>(trTable == NULL || theArray==NULL)
01074     <a class="code" href="usrlib.h.html#a12">usrErr</a>(<font class="stringliteral">"Plcm"</font>,ENOTMEM);
01075 
01076 
01077                 <font class="comment">// now filling-in these</font>
01078                 <font class="comment">// structures.</font>
01079 
01080   <font class="keywordflow">for</font>(LAYINST* liPtr=theSlice-&gt;chld.layinst;liPtr!=NULL;liPtr=liPtr-&gt;next)
01081   {
01082     <a class="code" href="class_list.html">List</a>&amp; listRef=(<a class="code" href="class_list.html">List</a>&amp;)(*liPtr-&gt;layout-&gt;flag.p);
01083     <a class="code" href="class_listiterator.html">ListIterator</a> lIter(listRef);
01084     <a class="code" href="class_pattern.html">Pattern</a>&amp; patRef=(<a class="code" href="class_pattern.html">Pattern</a>&amp;)(<a class="code" href="class_item.html">Item</a>&amp;)lIter;
01085                 <font class="comment">// the first one contains transMaps;</font>
01086     
01087     <a class="code" href="class_transparency.html">Transparency</a> *tranMaps=patRef.<a class="code" href="class_pattern.html#a11">getTranMaps</a>();
01088     
01089     <font class="keywordflow">if</font>(tranMaps==NULL)
01090       <a class="code" href="usrlib.h.html#a12">usrErr</a>(<font class="stringliteral">"Plcm::calcTransp"</font>,EUNKNOW);
01091 
01092 
01093     <font class="keywordtype">int</font> newCx,newCy;
01094                 <font class="comment">// find the new left bottom bottom corner of </font>
01095                 <font class="comment">// the cell</font>
01096 
01097     patRef.<a class="code" href="class_pattern.html#a12">findNewLeftBottom</a>(liPtr-&gt;layout-&gt;bbx[HOR],liPtr-&gt;layout-&gt;bbx[VER],
01098                  liPtr-&gt;mtx,newCx,newCy);
01099 
01100                 <font class="comment">// now for every layer</font>
01101 
01102     <font class="keywordflow">for</font>(<font class="keywordtype">int</font> l=0;l&lt;thisImage.numlayers;l++)
01103     {
01104       <a class="code" href="class_transparency.html">Transparency</a>* tranMap=&amp;tranMaps[l];
01105 
01106                 <font class="comment">// now a small detail - the cell could be </font>
01107                 <font class="comment">// placed upside down or even mirrored -</font>
01108                 <font class="comment">// this may require some transformations</font>
01109 
01110       <a class="code" href="class_transparency.html">Transparency</a>* transformedMap = tranMap-&gt;<a class="code" href="class_transparency.html#a5">transform</a>(liPtr-&gt;mtx);
01111 
01112     
01113       <font class="keywordtype">int</font> offset;
01114 
01115       transGridType* destPtr,*end,*srcPtr;
01116       
01117       <font class="keywordflow">if</font>(thisImage.routeorient[l]==HOR)
01118       {
01119     offset=newCy-(cYstart*thisImage.size[VER]); 
01120     destPtr=trTable[l].verGridMap+offset;
01121     <font class="keywordflow">if</font>(offset+transformedMap-&gt;sizeVer &lt; trTable[l].sizeVer)
01122       end=destPtr+transformedMap-&gt;sizeVer;
01123     <font class="keywordflow">else</font>
01124       end=trTable[l].verGridMap+trTable[l].sizeVer;
01125     <font class="keywordflow">if</font>(offset &lt; 0)      <font class="comment">// cell is partially located below </font>
01126     {           <font class="comment">// the slice</font>
01127       destPtr=trTable[l].verGridMap;
01128       srcPtr=transformedMap-&gt;verGridMap-offset;
01129     }
01130     <font class="keywordflow">else</font>
01131       srcPtr=transformedMap-&gt;verGridMap;
01132       }
01133       <font class="keywordflow">else</font>
01134       {
01135     offset=newCx-(cXstart*thisImage.size[HOR]); 
01136     destPtr=trTable[l].horGridMap+offset;
01137     <font class="keywordflow">if</font>(offset+transformedMap-&gt;sizeHor &lt; trTable[l].sizeHor)
01138       end=destPtr+transformedMap-&gt;sizeHor;
01139     <font class="keywordflow">else</font>
01140       end=trTable[l].horGridMap+trTable[l].sizeHor;
01141     <font class="keywordflow">if</font> (offset&lt;0)
01142     {
01143       destPtr=trTable[l].horGridMap;
01144       srcPtr=transformedMap-&gt;horGridMap-offset;
01145     }
01146     <font class="keywordflow">else</font>
01147       srcPtr=transformedMap-&gt;horGridMap;
01148     
01149       }
01150                 <font class="comment">// now let\'s do logical and-ing</font>
01151 
01152       <font class="keywordflow">for</font>(;destPtr&lt;end;destPtr++,srcPtr++)
01153     *destPtr|=*srcPtr;
01154 
01155       <font class="keyword">delete</font> transformedMap;
01156     }
01157   }
01158 
01159                 <font class="comment">// now let's fill in the output array</font>
01160 
01161   <font class="keywordflow">for</font>(<font class="keywordtype">int</font> lay=0;lay&lt;thisImage.numlayers;lay++)
01162   {
01163     <a class="code" href="class_transparency.html">Transparency</a> &amp;tPtr=trTable[lay];
01164 
01165     theArray[lay]=tPtr.<a class="code" href="class_transparency.html#a4">freeTracks</a>(thisImage.routeorient[lay]);
01166 
01167   }
01168   <font class="keyword">delete</font> trTable;
01169 
01170 
01171 
01172   <font class="keywordflow">return</font> theArray;
01173 
01174 }<font class="comment">// Plcm::calcTransp  //</font>
01175 
01176 <font class="comment">//----------------------------------------------------------------------------</font>
<a name="l01177"></a><a class="code" href="class_plcm.html#a10">01177</a> <font class="keywordtype">void</font> <a class="code" href="class_plcm.html#a10">Plcm::doTranspAnalysis</a>(<font class="keywordtype">void</font>)
01178 <font class="comment">//</font>
01179 <font class="comment">// Perform transparency analysis for every slice.</font>
01180 {
01181   <font class="keywordtype">int</font> i,j;
01182 
01183   <font class="keywordflow">if</font>(!slicingLayout)
01184     <a class="code" href="usrlib.h.html#a12">usrErr</a>(<font class="stringliteral">"Plcm::doTranspAnalysis"</font>,EUNKNOW);
01185     SLICE* slvPtr,*slhPtr;
01186 
01187     <font class="keywordflow">for</font>(i=0,slvPtr=layoutToBuild-&gt;slice-&gt;chld.slice;
01188     slvPtr!=NULL &amp;&amp; i&lt;slicesInHor;i++,slvPtr=slvPtr-&gt;next)
01189       <font class="keywordflow">for</font>(j=0,slhPtr=slvPtr-&gt;chld.slice;
01190           slhPtr!=NULL &amp;&amp; j&lt;slicesInVer;j++,slhPtr=slhPtr-&gt;next)
01191       {
01192     <a class="code" href="class__slice_info.html">SLICE_INFO</a>* tdPtr=(<a class="code" href="class__slice_info.html">SLICE_INFO</a>*)slhPtr-&gt;flag.p;
01193     tdPtr-&gt;layerTrans=calcTransp(slhPtr);
01194 
01195 <font class="preprocessor">#ifdef TRANS_DEBUG 
</font>01196 <font class="preprocessor"></font>
01197         cout &lt;&lt; <font class="stringliteral">"("</font> &lt;&lt; tdPtr-&gt;cX &lt;&lt; <font class="stringliteral">","</font>
01198          &lt;&lt; tdPtr-&gt;cY &lt;&lt; <font class="stringliteral">","</font>
01199          &lt;&lt; tdPtr-&gt;width &lt;&lt; <font class="stringliteral">","</font>
01200          &lt;&lt; tdPtr-&gt;height &lt;&lt; <font class="stringliteral">")"</font>;
01201     
01202     <font class="keywordflow">for</font>(<font class="keywordtype">int</font> k=0;k&lt;thisImage.numlayers;k++)
01203       cout &lt;&lt; <font class="stringliteral">"["</font> &lt;&lt; tdPtr-&gt;layerTrans[k] &lt;&lt; <font class="stringliteral">"]"</font>;
01204     cout &lt;&lt; endl;
01205 <font class="preprocessor">#endif
</font>01206 <font class="preprocessor"></font>
01207       }
01208   
01209 }<font class="comment">// Plcm::doTranspAnalysis  //</font>
01210 
01211 <font class="comment">//----------------------------------------------------------------------------</font>
<a name="l01212"></a><a class="code" href="class_plcm.html#c14">01212</a> SLICE* <a class="code" href="class_plcm.html#c14">Plcm::findSlice</a>(CIRINST* ciPtr)
01213 <font class="comment">//</font>
01214 <font class="comment">//</font>
01215 {
01216   <font class="keywordtype">int</font>     partNo = atoi(ciPtr-&gt;name) - 1 ;
01217   <font class="keywordtype">int</font>     x,y;
01218   x = partNo % slicesInHor; <font class="comment">// row &amp; column no. (from 0)</font>
01219   y = partNo / slicesInHor;
01220     
01221                 <font class="comment">// now we have to find the right slice</font>
01222                 <font class="comment">// layinst pointer</font>
01223   SLICE* slvPtr,*slhPtr;
01224   <font class="keywordtype">int</font> i,j;
01225   
01226   <font class="keywordflow">for</font>(i=0,slvPtr=layoutToBuild-&gt;slice-&gt;chld.slice;
01227       slvPtr!=NULL &amp;&amp; i&lt;x;i++,slvPtr=slvPtr-&gt;next);
01228   <font class="keywordflow">for</font>(j=0,slhPtr=slvPtr-&gt;chld.slice;
01229       slhPtr!=NULL &amp;&amp; j&lt;y;j++,slhPtr=slhPtr-&gt;next);
01230                 <font class="comment">// now shlPtr points to the right slice</font>
01231     
01232     
01233   <font class="keywordflow">return</font> slhPtr;
01234 
01235 }<font class="comment">// Plcm::findSlice  //</font>
01236 
01237 <font class="comment">//----------------------------------------------------------------------------</font>
<a name="l01238"></a><a class="code" href="class_plcm.html#c15">01238</a> <font class="keywordtype">void</font> <a class="code" href="class_plcm.html#c15">Plcm::removeEmptySlices</a>(<font class="keywordtype">void</font>)
01239 <font class="comment">//</font>
01240 <font class="comment">// Some slices may turn out to be empty - we remove them.</font>
01241 {
01242   <font class="keywordflow">if</font>(slicingLayout)
01243   {
01244     SLICE* slvPtr,*slhPtr,*prevPtr,*prevVPtr;;
01245     <font class="keywordtype">int</font> i,j;
01246 
01247     prevVPtr=layoutToBuild-&gt;slice;
01248 
01249     <font class="keywordflow">for</font>(i=0,slvPtr=layoutToBuild-&gt;slice-&gt;chld.slice;
01250     slvPtr!=NULL &amp;&amp; i&lt;slicesInHor;i++)
01251     {
01252       prevPtr=slvPtr;
01253       <font class="keywordflow">for</font>(j=0,slhPtr=slvPtr-&gt;chld.slice;
01254           slhPtr!=NULL &amp;&amp; j&lt;slicesInVer;j++)
01255       {
01256     <font class="keywordflow">if</font>(slhPtr-&gt;chld.layinst==NULL) <font class="comment">// we have to unlink that one</font>
01257     {
01258       <font class="keywordflow">if</font>(prevPtr==slvPtr)
01259         slvPtr-&gt;chld.slice=slhPtr-&gt;next;
01260       <font class="keywordflow">else</font>
01261         prevPtr-&gt;next=slhPtr-&gt;next;
01262       SLICE *tmp=slhPtr;
01263       slhPtr=slhPtr-&gt;next;
01264 
01265       <a class="code" href="class__slice_info.html">SLICE_INFO</a>* tdPtr=(<a class="code" href="class__slice_info.html">SLICE_INFO</a>*)tmp-&gt;flag.p;
01266       <font class="keywordflow">if</font> (doTransAna)
01267         <font class="keyword">delete</font> tdPtr-&gt;layerTrans;
01268       <font class="keyword">delete</font> tdPtr;
01269       FreeSlice(tmp);
01270     }
01271     <font class="keywordflow">else</font>
01272     {
01273       prevPtr=slhPtr;
01274       slhPtr=slhPtr-&gt;next;
01275 
01276     }
01277       }             <font class="comment">// it may also happen that we</font>
01278                 <font class="comment">// remove all vertical subslices</font>
01279       <font class="keywordflow">if</font>(slvPtr-&gt;chld.slice==NULL)
01280       {             <font class="comment">// unplug this vertical slice</font>
01281                 <font class="comment">// because it\'s empty</font>
01282     
01283     <font class="keywordflow">if</font>(prevVPtr==layoutToBuild-&gt;slice)
01284       layoutToBuild-&gt;slice-&gt;chld.slice=slvPtr-&gt;next;
01285     <font class="keywordflow">else</font>
01286       prevVPtr-&gt;next=slvPtr-&gt;next;
01287     SLICE *vTmp=slvPtr;
01288     slvPtr=slvPtr-&gt;next;
01289     
01290     FreeSlice(vTmp);
01291       }
01292       <font class="keywordflow">else</font>
01293       {
01294     prevVPtr=slvPtr;
01295     slvPtr=slvPtr-&gt;next;    
01296       }
01297 
01298 
01299     }
01300   }
01301 }<font class="comment">// Plcm::removeEmptySlices  //</font>
</div></pre><hr><address><small>Generated at Thu Sep 28 15:38:02 2000 for madonna by
<a href="http://www.stack.nl/~dimitri/doxygen/index.html">
<img src="doxygen.gif" alt="doxygen" align=center border=0 
width=110 height=53></a>1.1.5 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy; 1997-2000</small></address>
</body>
</html>
