<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta name="robots" content="noindex">
<title>plcminit.C Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body bgcolor="#ffffff">
<!-- Generated by Doxygen 1.1.5 on Thu Sep 28 15:38:02 2000 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>plcminit.C</h1><a href="plcminit.C.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">// ********************************************************</font>
00002 <font class="comment">// *  PLCMINIT.C Set of routines used during construction *</font>
00003 <font class="comment">// *    @(#)plcminit.C 1.24 09/01/99 Delft University of Technology </font>
00004 <font class="comment">// ********************************************************</font>
00005 
00006 <font class="preprocessor">#include &lt;stdlib.h&gt;</font>
00007 <font class="preprocessor">#include &lt;string.h&gt;</font>
00008 <font class="preprocessor">#include &lt;math.h&gt;</font>
00009 <font class="preprocessor">#include "<a class="code" href="plcm.h.html">plcm.h</a>"</font>
00010 
00011 <font class="keyword">extern</font>  LINKAGE_TYPE
00012 {
00013   <font class="keywordtype">int</font> sdflistlay(<font class="keywordtype">long</font> ,CIRCUIT *);
00014 }
00015 
00016 <font class="preprocessor">#define  CHANNEL_DEBUG 0
</font>00017 <font class="preprocessor"></font>
00018 <font class="comment">//--------------------------------------------------------------</font>
00019                <font class="keywordtype">void</font>  <a class="code" href="class_plcm.html#c1">Plcm::clearFlags</a>(CIRCUIT *cPtr)
00020 <font class="comment">//</font>
00021 <font class="comment">// Clears flag.l of each circuit simply to avoid multiple</font>
00022 <font class="comment">// layout reading and cirinst to keep track of still not</font>
00023 <font class="comment">// placed cells.</font>
00024 {
00025   cPtr-&gt;flag.l= 0;
00026   <font class="keywordflow">for</font>(CIRINST *ciPtr=cPtr-&gt;cirinst;ciPtr!=NULL;ciPtr=ciPtr-&gt;next)
00027   {
00028     ciPtr-&gt;flag.l=0;
00029     clearFlags(ciPtr-&gt;circuit);
00030   }
00031 
00032 }<font class="comment">// Plcm::clearFlags  //</font>
00033 
00034 <font class="comment">//--------------------------------------------------------------</font>
00035                <font class="keywordtype">double</font> <a class="code" href="class_plcm.html#c2">Plcm::readLayouts</a>(CIRCUIT *cPtr)
00036 <font class="comment">//</font>
00037 <font class="comment">//  reads all layouts of leaves circuits, calculates total area,</font>
00038 <font class="comment">//  in every circuit node sets number of children.</font>
00039 {
00040 
00041 
00042   <font class="keywordflow">if</font>(cPtr== NULL)
00043   {
00044     <a class="code" href="usrlib.h.html#a12">usrErr</a>(<font class="stringliteral">"Plcm::readLayouts"</font>,EUNKNOW);
00045   }
00046 
00047   <font class="keywordflow">if</font>( cPtr-&gt;status != NULL &amp;&amp; 
00048      (strstr(cPtr-&gt;status-&gt;program,"mad_prim")!=NULL || 
00049       strstr(cPtr-&gt;status-&gt;program,"libprim")!=NULL) )  <font class="comment">// libprim child</font>
00050   {
00051     <font class="keywordtype">int</font> max=0;    
00052 
00053     <font class="keywordflow">if</font>(cPtr-&gt;flag.l == 0)     <font class="comment">// this layout still not read</font>
00054     {
00055       <font class="keywordflow">if</font>(sdflistlay(SDFLAYALL,cPtr) == 0)    <font class="comment">// reads all layout </font>
00056     <a class="code" href="usrlib.h.html#a12">usrErr</a>(<font class="stringliteral">"Plcm::readLayouts"</font>,EINPDAT);    <font class="comment">// implementations of circuit</font>
00057     }                                           
00058                                                 
00059     <font class="keywordflow">for</font>(LAYOUT *lPtr=cPtr-&gt;layout;lPtr!=NULL;lPtr=lPtr-&gt;next)
00060     {
00061       <font class="keywordflow">if</font>(strstr(lPtr-&gt;name,"Tmp_Cell_")==NULL ) <font class="comment">// don't consider </font>
00062                                             <font class="comment">// nelsis's tmp cells</font>
00063     
00064       {
00065     <font class="keywordflow">if</font>(sdfreadalllay(SDFLAYALL,
00066              lPtr-&gt;name,cPtr-&gt;name,cPtr-&gt;function-&gt;name,
00067              cPtr-&gt;function-&gt;library-&gt;name) == 0)    
00068       <a class="code" href="usrlib.h.html#a12">usrErr</a>(<font class="stringliteral">"Plcm::readLayouts"</font>,EINPDAT);  
00069     
00070     <font class="keywordflow">if</font>(cPtr-&gt;flag.l == 0)   <font class="comment">// we have to create translists too</font>
00071       lPtr-&gt;flag.p = (<font class="keywordtype">char</font>*)transList(lPtr,&amp;thisImage);  
00072                             <font class="comment">// it's a list of patterns after all possible</font>
00073                             <font class="comment">// transformations.</font>
00074     <font class="keywordtype">int</font> horSize = int(ceil((<font class="keywordtype">double</font>)lPtr-&gt;bbx[HOR]/thisImage.size[HOR]))*
00075       thisImage.size[HOR],
00076     verSize = int(ceil((<font class="keywordtype">double</font>)lPtr-&gt;bbx[VER]/thisImage.size[VER]))*
00077       thisImage.size[VER];
00078     
00079     
00080     <font class="keywordtype">int</font> bbxSize = horSize*verSize;
00081     <font class="keywordflow">if</font>( bbxSize &gt; max)
00082       max=bbxSize;
00083     
00084       }
00085     }
00086     cPtr-&gt;flag.l=1;
00087     
00088     <font class="keywordflow">return</font> max;
00089     
00090   }
00091   <font class="keywordflow">else</font>
00092   {
00093     <font class="keywordtype">double</font> area=0;
00094     <font class="keywordtype">int</font> i=0;
00095 
00096     <font class="keywordflow">for</font>(CIRINST *ciPtr=cPtr-&gt;cirinst;ciPtr!=NULL;ciPtr=ciPtr-&gt;next,i++)
00097     {
00098       area+=readLayouts(ciPtr-&gt;circuit);
00099     }
00100    
00101     <font class="keywordflow">if</font> (cPtr-&gt;flag.l != 0)              <font class="comment">// recursive circuit call exists</font>
00102     {
00103       cerr &lt;&lt; <font class="stringliteral">"\n Propably You've  forgotten to flatten Your circuit !! \n"</font>
00104           &lt;&lt; <font class="stringliteral">" Run madonna with -u option first. \n\n"</font>;
00105       <a class="code" href="usrlib.h.html#a12">usrErr</a>(<font class="stringliteral">"Plcm::readLayouts"</font>,EINPDAT);
00106     }
00107     cPtr-&gt;flag.l=i;
00108     <font class="keywordflow">return</font> area;
00109     
00110   }
00111   
00112 }<font class="comment">// Plcm::readLayouts  //</font>
00113 
00114 
00115 <font class="comment">//--------------------------------------------------------------</font>
00116                <a class="code" href="class_list.html">List</a>* <a class="code" href="class_plcm.html#c3">Plcm::transList</a>(LAYOUT *lPtr,<a class="code" href="class__imagedesc.html">IMAGEDESC</a> *iPtr)
00117 <font class="comment">//</font>
00118 <font class="comment">//  Returns a reference to allocated list of all possible patterns</font>
00119 <font class="comment">//  for each tranformation matrix.</font>
00120 <font class="comment">//</font>
00121 {
00122   <a class="code" href="class_list.html">List</a> *listPtr =  <font class="keyword">new</font> List();
00123   <a class="code" href="class_pattern.html">Pattern</a> *patPtr;
00124   <a class="code" href="class_laymap.html">LayMap</a> layMap(lPtr,imageMap,&amp;freeNets);
00125   <font class="keywordtype">int</font> doCheck = lPtr-&gt;bbx[HOR]*lPtr-&gt;bbx[VER]/(iPtr-&gt;size[HOR]*iPtr-&gt;size[VER]) &lt; 30;
00126   <font class="keywordtype">int</font> isMacro;          <font class="comment">// if the cell is bigger than certain limit </font>
00127                 <font class="comment">// it will be treated as macro (no patterns </font>
00128                 <font class="comment">// generation and only one orietation allowed)</font>
00129 
00130   isMacro=lPtr-&gt;bbx[HOR]*lPtr-&gt;bbx[VER]/
00131           (iPtr-&gt;size[HOR]*iPtr-&gt;size[VER]) &gt; macroMinSize;
00132 
00133          <font class="comment">// switched off totally until tested</font>
00134    doCheck=<font class="keyword">false</font>;
00135   
00136   <font class="keywordflow">if</font>(!isMacro)
00137   {
00138     <font class="keywordflow">for</font>(<a class="code" href="class__mirror.html">MIRROR</a> *mPtr=iPtr-&gt;mirroraxis;mPtr!=NULL;mPtr=mPtr-&gt;next)
00139     {
00140       
00141     <font class="comment">// pattern with sectors infornation and</font>
00142     <font class="comment">// critical points coming from metal layers</font>
00143       
00144       patPtr = <font class="keyword">new</font> Pattern(lPtr,iPtr,mPtr-&gt;mtx,layMap,doCheck);
00145       
00146     <font class="comment">// removing metal critical points when</font>
00147     <font class="comment">// they lay inside cell</font>
00148       
00149       <font class="keywordflow">if</font>(doCheck)
00150       {
00151     patPtr-&gt;<a class="code" href="class_pattern.html#a7">removeUnnessesery</a>(*imageMap);
00152     
00153       <font class="comment">// adding critical islands and feeds</font>
00154     
00155                 <font class="comment">// first we check if the isn't to big to do this</font>
00156     
00157     
00158     patPtr-&gt;<a class="code" href="class_pattern.html#a6">addCriticals</a>(layMap);
00159       }
00160       
00161       
00162       listPtr-&gt;<a class="code" href="class_list.html#a3">add</a>( *patPtr);
00163     }
00164   }
00165                                <font class="comment">// identity matrix we place at</font>
00166                                <font class="comment">// the end of our job because we want it</font>
00167                                <font class="comment">// be in head of list</font>
00168 
00169   patPtr = <font class="keyword">new</font> Pattern(lPtr,iPtr,<a class="code" href="im.h.html#a2">mtxidentity</a>(),layMap,doCheck,
00170                isMacro,doTransAna);
00171                 <font class="comment">// isMacro - a big cell - treat it special</font>
00172                 <font class="comment">// transAna - transparency analysis -''-</font>
00173   
00174   <font class="keywordflow">if</font>(doCheck)
00175   {
00176     patPtr-&gt;<a class="code" href="class_pattern.html#a7">removeUnnessesery</a>(*imageMap);
00177     patPtr-&gt;<a class="code" href="class_pattern.html#a6">addCriticals</a>(layMap);
00178   }
00179 
00180 
00181   listPtr-&gt;<a class="code" href="class_list.html#a3">add</a>(*patPtr);
00182   
00183   <font class="keywordflow">if</font> (verboseMode)
00184   {
00185     cout &lt;&lt; <font class="stringliteral">" Layout "</font> &lt;&lt; lPtr-&gt;name &lt;&lt; <font class="charliteral">'\n'</font>;
00186     cout &lt;&lt; *listPtr&lt;&lt; flush;
00187   }
00188   
00189   <font class="keywordflow">return</font> listPtr;
00190 
00191 }<font class="comment">// Plcm::transList  //</font>
00192 
00193 
00194 <font class="comment">//--------------------------------------------------------------</font>
00195 <font class="keywordtype">void</font>  <a class="code" href="class_plcm.html#c5">Plcm::makeWindows</a>(CIRCUIT *cPtr,Boolean makeChannels)
00196 <font class="comment">//</font>
00197 <font class="comment">// Recursivly devides given circuit with its window for number of</font>
00198 <font class="comment">// new windows ,one for  each cirinst.</font>
00199 <font class="comment">//</font>
00200 {
00201 
00202 
00203   <font class="keywordflow">if</font>( cPtr-&gt;cirinst==NULL || 
00204       (cPtr-&gt;cirinst-&gt;circuit-&gt;status != NULL &amp;&amp;
00205      (strstr(cPtr-&gt;cirinst-&gt;circuit-&gt;status-&gt;program,"mad_prim")!=NULL ||
00206       strstr(cPtr-&gt;cirinst-&gt;circuit-&gt;status-&gt;program,"libprim")!=NULL ))  ) 
00207   {
00208     <font class="keywordflow">return</font>;     <font class="comment">// this window already can not be devided</font>
00209   }
00210   
00211   <a class="code" href="class_window.html">Window</a>  &amp;wRef = *(<a class="code" href="class_window.html">Window</a>*)cPtr-&gt;flag.p ;
00212   
00213   <font class="keywordtype">int</font> colNum,rowNum,newWidth,newHigh,
00214       x=wRef.cX,y=wRef.cY;
00215   <font class="keywordtype">int</font> hor=thisImage.size[HOR],
00216       ver=thisImage.size[VER];
00217   <font class="keywordtype">int</font> xend=wRef.cX + wRef.width,
00218       yend=wRef.cY + wRef.high;
00219 
00220   wRef.<a class="code" href="class_window.html#a4">getDiv</a>(cPtr-&gt;name,&amp;colNum,&amp;rowNum,&amp;newWidth,&amp;newHigh);        
00221 
00222   slicesInHor=colNum;
00223   slicesInVer=rowNum;
00224                                               <font class="comment">// new dimensions of child </font>
00225                                               <font class="comment">// windows</font>
00226 
00227   <font class="keywordflow">if</font>(makeChannels)                <font class="comment">// the newHigh &amp; newWidth</font>
00228   {                       <font class="comment">// are wrong - we have to </font>
00229                                               <font class="comment">// calculate them again</font>
00230     <font class="keywordtype">int</font> i,chaWidthInHor=0,chaWidthInVer=0;
00231     <font class="keywordflow">for</font>(i=0;i&lt;colNum-1;i++)
00232       chaWidthInHor+=globRouting-&gt;vertical_channels[i].ncells;
00233     <font class="keywordflow">for</font>(i=0;i&lt;rowNum-1;i++)
00234       chaWidthInVer+=globRouting-&gt;horizontal_channels[i].ncells;
00235 
00236     newWidth=(wRef.width-chaWidthInHor)/colNum;
00237     newHigh=(wRef.high-chaWidthInVer)/rowNum;
00238                 <font class="comment">// so these are the right sizes of subwindows</font>
00239   }
00240 
00241 
00242   <font class="keywordflow">if</font> ( newHigh == 0 || newWidth == 0)
00243     <a class="code" href="usrlib.h.html#a12">usrErr</a>(<font class="stringliteral">"Plcm::makeWindows"</font>,EUNKNOW);
00244 
00245   
00246   <font class="keywordflow">for</font>(CIRINST *ciPtr=cPtr-&gt;cirinst;ciPtr != NULL;ciPtr=ciPtr-&gt;next)
00247   {
00248     <font class="keywordtype">int</font>     partNo = atoi(ciPtr-&gt;name) - 1 ;
00249                             <font class="comment">// number of part. - begin at left-bottom</font>
00250                             <font class="comment">// goes left and ends in upper-right corner</font>
00251 
00252     x = partNo % colNum;    <font class="comment">// row &amp; column no. (from 0)</font>
00253     y = partNo / colNum;    
00254 
00255     <font class="keywordtype">int</font> a,b;
00256 
00257 
00258     a = wRef.cX + x * newWidth;       <font class="comment">// left-bottom coord.</font>
00259     b = wRef.cY + y * newHigh;
00260     
00261 
00262     <font class="keywordflow">if</font>(makeChannels)        <font class="comment">// then we have to add width of channels</font>
00263     {               <font class="comment">// which are located to the down-left from </font>
00264                 <font class="comment">// the new subwindow</font>
00265       <font class="keywordtype">int</font> i;
00266       <font class="keywordflow">for</font>(i=0;i&lt;x;i++)
00267     a+=globRouting-&gt;vertical_channels[i].ncells;
00268       <font class="keywordflow">for</font>(i=0;i&lt;y;i++)
00269     b+=globRouting-&gt;horizontal_channels[i].ncells;
00270     }
00271 
00272     <font class="keywordflow">if</font> (a &gt;= xend || b &gt;= yend)
00273       <a class="code" href="usrlib.h.html#a12">usrErr</a>(<font class="stringliteral">"Plcm::makeWindows"</font>,EUNKNOW);
00274     
00275     
00276 
00277     <a class="code" href="class_cluster.html">Cluster</a> cls = Cluster(a,b,hor,ver);
00278     <a class="code" href="class_window.html">Window</a>  *newWindow =  <font class="keyword">new</font> Window(cls,
00279                             ( x == colNum-1 ? xend-a : newWidth),
00280                             ( y == rowNum-1 ? yend-b : newHigh) );
00281                             
00282                             <font class="comment">// these strange expresions are for most right </font>
00283                             <font class="comment">// and top windows</font>
00284 
00285     <font class="keywordflow">if</font>(makeChannels &amp;&amp; x!=colNum-1 &amp;&amp; y!=rowNum-1) 
00286     {
00287       blockChannels(newWindow,x,y); 
00288                                 <font class="comment">// this routine will block channels</font>
00289                 <font class="comment">// from the right and top size if</font>
00290                 <font class="comment">// necessary</font>
00291     }
00292 
00293     ciPtr-&gt;circuit-&gt;flag.p=(<font class="keywordtype">char</font>*)newWindow;
00294     makeWindows(ciPtr-&gt;circuit);
00295     
00296   }
00297 
00298 <font class="preprocessor">#if CHANNEL_DEBUG == 1
</font>00299 <font class="preprocessor"></font>                                <font class="comment">// debug time :</font>
00300                 <font class="comment">// prints the status of the placement</font>
00301                 <font class="comment">// plane after aloocating channels</font>
00302 
00303   <font class="keywordflow">for</font>(<font class="keywordtype">int</font> v=wRef.high-1;v&gt;=0;v--)
00304   {
00305     <font class="keywordflow">for</font>(<font class="keywordtype">int</font> h=0;h&lt;wRef.width;h++)
00306       <font class="keywordflow">if</font> (plane-&gt;getPattern(h,v))
00307     cout &lt;&lt; <font class="stringliteral">"1"</font>;
00308       <font class="keywordflow">else</font>
00309     cout &lt;&lt; <font class="stringliteral">"0"</font>;
00310     cout &lt;&lt; endl;
00311   }  
00312 
00313 <font class="preprocessor">#endif
</font>00314 <font class="preprocessor"></font>
00315   
00316 }<font class="comment">// Plcm::makeWindows  //</font>
00317 
00318 
00319 <font class="comment">//----------------------------------------------------------------------------</font>
00320                <font class="keywordtype">void</font>  <a class="code" href="class_plcm.html#a11">Plcm::addFreeNet</a>(<font class="keywordtype">char</font> *name)
00321 <font class="comment">//</font>
00322 <font class="comment">// Adds new free net name to the predefined list.</font>
00323 <font class="comment">//</font>
00324 {
00325     freeNets.add( *<font class="keyword">new</font> CriNet(cs(name)));
00326 
00327 }<font class="comment">// Plcm::addFreeNet  //</font>
00328 
00329 <font class="comment">//----------------------------------------------------------------------------</font>
00330 <font class="keywordtype">void</font> <a class="code" href="class_plcm.html#c4">Plcm::blockChannels</a>(<a class="code" href="class_window.html">Window</a>* window,<font class="keywordtype">int</font> x,<font class="keywordtype">int</font> y)
00331 <font class="comment">//</font>
00332 <font class="comment">// This routine blocks channels on the top and right from the window "window"</font>
00333 <font class="comment">// if necessary. To do this it marks appropriate regions in placement plane. </font>
00334 <font class="comment">// We do it only if there's big enough congestion there. </font>
00335 {
00336   <a class="code" href="class__routing_info.html">ROUTING_INFO</a> &amp;rInfo=globRouting-&gt;small_channels[x][y];
00337   <a class="code" href="class__routing_channel.html">ROUTING_CHANNEL</a> &amp;horCh=rInfo.channel[HOR],
00338                   &amp;verCh=rInfo.channel[VER];
00339 
00340   <font class="keywordtype">int</font> i,j;          <font class="comment">// temporary variables:</font>
00341   clusterMapType  pat=0;
00342   pat=~pat;         <font class="comment">// this sets all our bits to 1</font>
00343   <a class="code" href="class_list.html">List</a>  em;
00344   
00345                 <font class="comment">// first the top channel</font>
00346 
00347   <font class="keywordflow">if</font>(horCh.nwires/double(horCh.ncells*thisImage.size[VER])
00348              &gt; MAX_NON_BLOCK_DSTY_VER)
00349   {
00350     <font class="keywordflow">for</font>(i=window-&gt;cX;i&lt;window-&gt;cX+window-&gt;width+verCh.ncells;i++)
00351       <font class="keywordflow">for</font>(j=window-&gt;cY+window-&gt;high;j&lt;window-&gt;cY+window-&gt;high+horCh.ncells;j++)
00352     plane-&gt;mark(i,j,pat,em); <font class="comment">// mark as used</font>
00353   }
00354 
00355                 <font class="comment">// and the right one...</font>
00356 
00357   <font class="keywordflow">if</font>(verCh.nwires/double(verCh.ncells*thisImage.size[HOR])
00358              &gt; MAX_NON_BLOCK_DSTY_HOR)
00359   {
00360     <font class="keywordflow">for</font>(i=window-&gt;cX+window-&gt;width;i&lt;window-&gt;cX+window-&gt;width+verCh.ncells;i++)
00361       <font class="keywordflow">for</font>(j=window-&gt;cY;j&lt;window-&gt;cY+window-&gt;high+horCh.ncells;j++)
00362     plane-&gt;mark(i,j,pat,em); <font class="comment">// mark as used</font>
00363   }
00364 
00365   
00366 }<font class="comment">// Plcm::blockChannels  //</font>
00367 
00368 
00369 
00370 
</div></pre><hr><address><small>Generated at Thu Sep 28 15:38:03 2000 for madonna by
<a href="http://www.stack.nl/~dimitri/doxygen/index.html">
<img src="doxygen.gif" alt="doxygen" align=center border=0 
width=110 height=53></a>1.1.5 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy; 1997-2000</small></address>
</body>
</html>
