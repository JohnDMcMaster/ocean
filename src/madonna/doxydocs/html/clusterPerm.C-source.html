<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta name="robots" content="noindex">
<title>clusterPerm.C Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body bgcolor="#ffffff">
<!-- Generated by Doxygen 1.1.5 on Thu Sep 28 15:37:54 2000 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>clusterPerm.C</h1><a href="clusterPerm.C.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">// Thought you'd get C, but you ended up looking at a -*- C++ -*- file.</font>
00002 <font class="comment">//</font>
00003 <font class="comment">//  @(#)clusterPerm.C 1.4 08/20/96 </font>
00004 <font class="comment">// </font>
00005 
00006 <font class="preprocessor">#include &lt;stream.h&gt;</font>
00007 <font class="preprocessor">#include &lt;stdlib.h&gt;</font>     <font class="comment">// atoi()</font>
00008 <font class="preprocessor">#include "<a class="code" href="matrixInt.h.html">matrixInt.h</a>"</font>
00009 <font class="preprocessor">#include "<a class="code" href="part.h.html">part.h</a>"</font>
00010 
00011 
00012 <font class="comment">// a connecInfo object enumerates the interconnections between clusters:</font>
<a name="l00013"></a><a class="code" href="class_connectinfo.html">00013</a> <font class="keyword">class </font><a class="code" href="class_connectinfo.html">connectInfo</a>: <font class="keyword">private</font> <a class="code" href="class_matrixint.html">matrixInt</a>
00014 {
00015 <font class="keyword">public</font>:
00016    <a class="code" href="class_connectinfo.html#a0">connectInfo</a>(<font class="keywordtype">int</font> numparts, CIRCUITPTR);
00017    <font class="keywordtype">int</font><a class="code" href="class_connectinfo.html#a1"> operator()</a>(<font class="keywordtype">int</font> pi, <font class="keywordtype">int</font> pj); <font class="comment">// #connections between partitions i and j</font>
<a name="l00018"></a><a class="code" href="class_connectinfo.html#a2">00018</a>    <font class="keywordtype">int</font> <a class="code" href="class_connectinfo.html#a2">numparts</a>()<font class="keyword"> </font>{<font class="keywordflow">return</font> <a class="code" href="class_matrixint.html#a4">dimension1</a>();}
00019 };
00020 
00021 
00022 <font class="comment">// a distInfo object enumerates the distance between two clusters:</font>
<a name="l00023"></a><a class="code" href="class_distinfo.html">00023</a> <font class="keyword">class </font><a class="code" href="class_distinfo.html">distInfo</a>: <font class="keyword">private</font> <a class="code" href="class_matrixint.html">matrixInt</a>
00024 {
00025 <font class="keyword">public</font>:
00026    <a class="code" href="class_distinfo.html#a0">distInfo</a>(<font class="keywordtype">int</font> nx, <font class="keywordtype">int</font> ny);
00027    <font class="keywordtype">int</font><a class="code" href="class_distinfo.html#a1"> operator()</a>(<font class="keywordtype">int</font> pi, <font class="keywordtype">int</font> pj); <font class="comment">// distance between partition i and j</font>
00028    <font class="keywordtype">void</font> <a class="code" href="class_distinfo.html#a2">exchange</a>(<font class="keywordtype">int</font> pi, <font class="keywordtype">int</font> pj);  <font class="comment">// exchange partitions i and j</font>
<a name="l00029"></a><a class="code" href="class_distinfo.html#a3">00029</a>    <font class="keywordtype">int</font> <a class="code" href="class_distinfo.html#a3">numparts</a>()<font class="keyword"> </font>{<font class="keywordflow">return</font> <a class="code" href="class_matrixint.html#a4">dimension1</a>();}
00030 };
00031 
00032 
<a name="l00033"></a><a class="code" href="class_connectinfo.html#a1">00033</a> <font class="keywordtype">int</font> <a class="code" href="class_connectinfo.html#a1">connectInfo::operator()</a>(<font class="keywordtype">int</font> pi, <font class="keywordtype">int</font> pj)<font class="keyword">
</font>00034 <font class="keyword"></font>{
00035    <a class="code" href="class_matrixint.html">matrixInt</a>&amp; mtx = (<a class="code" href="class_matrixint.html">matrixInt</a>&amp;) *<font class="keyword">this</font>;
00036    <font class="keywordflow">return</font> mtx[pi][pj];
00037 }
00038 
00039 <font class="comment">// initialize the connectivity matrix from the netlist of CIRCUIT:</font>
<a name="l00040"></a><a class="code" href="class_connectinfo.html#a0">00040</a> <a class="code" href="class_connectinfo.html#a0">connectInfo::connectInfo</a>(<font class="keywordtype">int</font> numparts, CIRCUITPTR circuit)
00041 :matrixInt(numparts, numparts)<font class="keyword">
</font>00042 <font class="keyword"></font>{
00043    <font class="keywordtype">int</font> *row = <font class="keyword">new</font> <font class="keywordtype">int</font>[numparts];
00044    <a class="code" href="class_matrixint.html">matrixInt</a>&amp; mtx = (<a class="code" href="class_matrixint.html">matrixInt</a>&amp;) *<font class="keyword">this</font>;
00045    <font class="keywordflow">for</font> (NETPTR net = circuit-&gt;netlist; net != NIL; net = net-&gt;next)
00046    {
00047       <font class="keywordtype">int</font> j;
00048       <font class="keywordflow">for</font> (j = 0; j &lt; numparts; ++j) row[j] = 0;
00049       <font class="comment">// now mark all partitions that this net connects to:</font>
00050       <font class="keywordflow">for</font> (CIRPORTREFPTR cpr = net-&gt;terminals; cpr != NIL; cpr = cpr-&gt;next)
00051       {
00052      <font class="keywordflow">if</font> (cpr-&gt;cirinst == NIL) <font class="keywordflow">continue</font>; <font class="comment">// terminal on top circuit</font>
00053      <font class="keywordtype">int</font> partition = atoi(cpr-&gt;cirinst-&gt;name) - 1;
00054      row[partition] = 1;    <font class="comment">// mark this partition</font>
00055       }
00056       <font class="comment">//</font>
00057       <font class="comment">// row[] is now a boolean vector with a 1 for each partition that is</font>
00058       <font class="comment">// visited by this net. Now add the matrix row*Transpose(row) to mtx:</font>
00059       <font class="keywordflow">for</font> (<font class="keywordtype">int</font> i = 0; i &lt; numparts; ++i)
00060       {
00061      <font class="keywordflow">if</font> (row[i] == 0) <font class="keywordflow">continue</font>; <font class="comment">// this net is not in partition i</font>
00062      <font class="keywordflow">for</font> (j = 0; j &lt; numparts; ++j)
00063         mtx[i][j] += row[j]; <font class="comment">// account for this net</font>
00064       }
00065    }
00066    <font class="keywordflow">for</font> (<font class="keywordtype">int</font> ij = 0; ij &lt; numparts; ++ij) mtx[ij][ij] = 0; <font class="comment">// reset diagonal</font>
00067    <font class="keyword">delete</font> row;
00068 }
00069 
00070 
00071 <font class="comment">// return the distance between partitions pi and pj.</font>
<a name="l00072"></a><a class="code" href="class_distinfo.html#a1">00072</a> <font class="keywordtype">int</font> <a class="code" href="class_distinfo.html#a1">distInfo::operator()</a>(<font class="keywordtype">int</font> pi, <font class="keywordtype">int</font> pj)<font class="keyword">
</font>00073 <font class="keyword"></font>{
00074    <a class="code" href="class_matrixint.html">matrixInt</a>&amp; mtx = (<a class="code" href="class_matrixint.html">matrixInt</a>&amp;) *<font class="keyword">this</font>;
00075    <font class="keywordflow">return</font> mtx[pi][pj];
00076 }
00077 
00078 
00079 <font class="comment">// exchange the partitions pi and pj. This means that the distances from pj to</font>
00080 <font class="comment">// any other partition are the distances that currently pi has to these other</font>
00081 <font class="comment">// partitions, and vice versa. So we can just exchange the columns pi and pj,</font>
00082 <font class="comment">// and exchange the rows pi and pj (order is unimportant).</font>
<a name="l00083"></a><a class="code" href="class_distinfo.html#a2">00083</a> <font class="keywordtype">void</font> <a class="code" href="class_distinfo.html#a2">distInfo::exchange</a>(<font class="keywordtype">int</font> pi, <font class="keywordtype">int</font> pj)<font class="keyword">
</font>00084 <font class="keyword"></font>{
00085    <a class="code" href="class_matrixint.html#a6">exchangeRows</a>(pi,pj);
00086    <a class="code" href="class_matrixint.html#a7">exchangeColumns</a>(pi,pj);
00087 }
00088 
00089 
<a name="l00090"></a><a class="code" href="clusterPerm.C.html#a1">00090</a> <font class="keyword">static</font> <font class="keyword">inline</font> <font class="keywordtype">int</font> <a class="code" href="clusterPerm.C.html#a1">absolute</a>(<font class="keywordtype">int</font> x)<font class="keyword"> </font>{<font class="keywordflow">if</font> (x &lt; 0) <font class="keywordflow">return</font> -x; <font class="keywordflow">else</font> <font class="keywordflow">return</font> x;}
00091 
00092 <font class="comment">// create a matrix[numparts][numparts] and init each entry (i,j) with the</font>
00093 <font class="comment">// distance from partition i to partition j:</font>
<a name="l00094"></a><a class="code" href="class_distinfo.html#a0">00094</a> <a class="code" href="class_distinfo.html#a0">distInfo::distInfo</a>(<font class="keywordtype">int</font> nx, <font class="keywordtype">int</font> ny)
00095 :matrixInt(nx * ny, nx * ny)<font class="keyword">
</font>00096 <font class="keyword"></font>{
00097    <font class="keywordflow">for</font> (<font class="keywordtype">int</font> i=0; i &lt; numparts(); ++i)
00098    {
00099       <font class="keywordtype">int</font> yi = i % nx;
00100       <font class="keywordtype">int</font> xi = i / nx;
00101       <font class="keywordflow">for</font> (<font class="keywordtype">int</font> j=0; j &lt; numparts(); ++j)
00102       {
00103      <font class="keywordtype">int</font> yj = j % nx;
00104      <font class="keywordtype">int</font> xj = j / nx;
00105      <font class="keywordtype">int</font> dist = <a class="code" href="clusterPerm.C.html#a1">absolute</a>(xi - xj) + <a class="code" href="clusterPerm.C.html#a1">absolute</a>(yi - yj);
00106      <a class="code" href="class_matrixint.html">matrixInt</a>&amp; mtx = (<a class="code" href="class_matrixint.html">matrixInt</a>&amp;) *<font class="keyword">this</font>;
00107      mtx[i][j] = dist;
00108       }
00109    }
00110 }
00111 
00112 
00113 <font class="comment">// Compute some measure of the current cluster cost. The lower this number, the</font>
00114 <font class="comment">// better the clustering. Cannot do better then zero!</font>
<a name="l00115"></a><a class="code" href="clusterPerm.C.html#a2">00115</a> <font class="keywordtype">int</font> <a class="code" href="clusterPerm.C.html#a2">clusterCost</a>(<a class="code" href="class_connectinfo.html">connectInfo</a>&amp; connectivity, <a class="code" href="class_distinfo.html">distInfo</a>&amp; distance)<font class="keyword">
</font>00116 <font class="keyword"></font>{
00117    <font class="keywordtype">int</font> cost = 0;
00118    <font class="keywordtype">int</font> numParts = connectivity.<a class="code" href="class_connectinfo.html#a2">numparts</a>();
00119    <font class="keywordflow">for</font> (<font class="keywordtype">int</font> i = 0; i &lt; numParts - 1; ++i)
00120       <font class="keywordflow">for</font> (<font class="keywordtype">int</font> j = i + 1; j &lt; numParts; ++j)
00121      cost += connectivity(i,j) * distance(i,j);
00122    <font class="keywordflow">return</font> cost;
00123 }
00124 
00125 
<a name="l00126"></a><a class="code" href="clusterPerm.C.html#a3">00126</a> <font class="keywordtype">void</font> <a class="code" href="clusterPerm.C.html#a3">applyPermutation</a>(<a class="code" href="class_connectinfo.html">connectInfo</a>&amp; connectivity, <a class="code" href="class_distinfo.html">distInfo</a>&amp; distance,
00127               <font class="keywordtype">int</font> a, <font class="keywordtype">int</font> b, <font class="keywordtype">int</font> *pi,
00128               <font class="keywordtype">int</font>&amp; bestCost, <font class="keywordtype">int</font> bestPerm[], <font class="keywordtype">int</font>&amp; worstCost)<font class="keyword">
</font>00129 <font class="keyword"></font>{
00130    <font class="keywordflow">if</font> (a == b) <font class="keywordflow">return</font>;
00131    a -= 1; b -= 1; pi += 1; <font class="comment">// Trotter-Johnson use range 1..n NOT 0..n-1</font>
00132    distance.<a class="code" href="class_distinfo.html#a2">exchange</a>(a, b); <font class="comment">// exchange the partitions a and b</font>
00133    <font class="keywordtype">int</font> thisCost = <a class="code" href="clusterPerm.C.html#a2">clusterCost</a>(connectivity, distance);
00134    <font class="keywordflow">if</font> (thisCost &lt; bestCost)
00135    {
00136       bestCost = thisCost;
00137       <font class="keywordtype">int</font> permsize = connectivity.<a class="code" href="class_connectinfo.html#a2">numparts</a>();
00138       <font class="keywordflow">for</font> (<font class="keywordtype">int</font> i = 0; i &lt; permsize; ++i)
00139      bestPerm[i] = pi[i];   <font class="comment">// save this permutation</font>
00140    }
00141    <font class="keywordflow">if</font> (thisCost &gt; worstCost) worstCost = thisCost;
00142 }
00143 
00144 
00145 
00146 <font class="comment">// This is a "minimal change" algorithm by Trotter and Johnson to generate all</font>
00147 <font class="comment">// permutations of the sequence 1,2,..,n. See Reingold, Nievergelt and Narsing</font>
00148 <font class="comment">// Deo, "Combinatorial Algorithms", Prentice Hall, 1977.</font>
00149 <font class="comment">// It is a minimum change algorithm because it only uses the "exchange two</font>
00150 <font class="comment">// neighbors" operation to permutate the order of the sequence.</font>
00151 <font class="comment">// On a HP9000/817 the function perm() generates about 1,250,000 permutations per</font>
00152 <font class="comment">// second, that is, perm(10) takes about 3 seconds to complete. These times of</font>
00153 <font class="comment">// course do not include the call to permprint() and assume "CC -O perm.C"...</font>
<a name="l00154"></a><a class="code" href="clusterPerm.C.html#a4">00154</a> <font class="keywordtype">void</font> <a class="code" href="clusterPerm.C.html#a4">generatePermutations</a>(<font class="keywordtype">int</font>&amp; bestCost, <font class="keywordtype">int</font> bestPerm[], <font class="keywordtype">int</font>&amp; worstCost,
00155               <a class="code" href="class_connectinfo.html">connectInfo</a>&amp; connectivity, <a class="code" href="class_distinfo.html">distInfo</a>&amp; distance)<font class="keyword">
</font>00156 <font class="keyword"></font>{
00157    <font class="keywordtype">int</font> n = distance.<a class="code" href="class_distinfo.html#a3">numparts</a>();
00158    <font class="keywordtype">int</font> m = n+1;
00159    <font class="comment">// pi[1..n] is "active", pi[0] and pi[n+1] are auxiliaries</font>
00160    <font class="keywordtype">int</font> *pi = <font class="keyword">new</font> <font class="keywordtype">int</font>[n+2];
00161    <font class="keywordtype">int</font> *p  = <font class="keyword">new</font> <font class="keywordtype">int</font>[n+2];
00162    <font class="keywordtype">int</font> *d  = <font class="keyword">new</font> <font class="keywordtype">int</font>[n+2];
00163 
00164    <font class="keywordflow">for</font> (<font class="keywordtype">int</font> i=1; i&lt;=n ; ++i)
00165    {
00166       pi[i] = p[i] = i;
00167       d[i] = -1;
00168    }
00169    d[1] = 0;
00170    pi[0] = pi[n+1] = m;
00171    <font class="keyword">register</font> <font class="keywordtype">int</font> a = 0, b = 0;
00172    <font class="keywordflow">while</font> (m &gt; 1)
00173    {
00174       <a class="code" href="clusterPerm.C.html#a3">applyPermutation</a>(connectivity, distance, a, b, pi,
00175                bestCost, bestPerm, worstCost);
00176       m = n;
00177       <font class="keywordflow">while</font> (pi[p[m]+d[m]] &gt; m)
00178       {
00179      d[m] = -d[m];
00180      --m;
00181       }
00182       <font class="comment">// exchange the two neighbors a and b:</font>
00183       a = p[m];
00184       b = p[m] + d[m];
00185       <font class="keyword">register</font> <font class="keywordtype">int</font> temp = pi[a];
00186       pi[a] = pi[b];
00187       pi[b] = temp;
00188       <font class="comment">// exchange some more things:</font>
00189       temp = p[pi[p[m]]];
00190       p[pi[p[m]]] = p[m];
00191       p[m] = temp;
00192    }
00193    <font class="keyword">delete</font> pi, p, d;
00194 }
00195 
00196 
<a name="l00197"></a><a class="code" href="clusterPerm.C.html#a5">00197</a> <font class="keywordtype">void</font> <a class="code" href="clusterPerm.C.html#a5">permutateThisPartitioning</a>(<a class="code" href="class__totalp.html">TOTALPPTR</a> total, <font class="keywordtype">int</font> bestPerm[])<font class="keyword">
</font>00198 <font class="keyword"></font>{
00199    CIRCUITPTR  c = total-&gt;bestpart;
00200    <font class="keywordflow">if</font> (c == NIL) <font class="keywordflow">return</font>;
00201    <font class="keywordflow">for</font> (CIRINSTPTR cinst = c-&gt;cirinst; cinst != NIL; cinst = cinst-&gt;next)
00202    {
00203       <font class="keywordtype">int</font> oldpartition = atoi(cinst-&gt;name);
00204       <font class="keywordtype">int</font> newpartition;
00205       <font class="keywordflow">for</font> (newpartition =0; newpartition &lt; total-&gt;numparts; ++newpartition)
00206      <font class="keywordflow">if</font> (bestPerm[newpartition] == oldpartition)
00207         <font class="keywordflow">break</font>;
00208       <font class="keywordflow">if</font> (newpartition &gt;= total-&gt;numparts)
00209      err(5,<font class="stringliteral">"permutate: internal error 5675"</font>);
00210       newpartition += 1;    <font class="comment">// since we start counting from 1, not 0 ...</font>
00211       fs(cinst-&gt;name);
00212       cinst-&gt;name = cs(form(<font class="stringliteral">"%d"</font>,newpartition));
00213    }
00214 }
00215 
00216 
<a name="l00217"></a><a class="code" href="clusterPerm.C.html#a0">00217</a> <font class="preprocessor">#define INFINITY 1000000
</font>00218 <font class="preprocessor"></font>
<a name="l00219"></a><a class="code" href="clusterPerm.C.html#a6">00219</a> <font class="keywordtype">int</font> <a class="code" href="clusterPerm.C.html#a6">clusterPermutate</a>(<a class="code" href="class__totalp.html">TOTALPPTR</a> total)<font class="keyword">
</font>00220 <font class="keyword"></font>{
00221    <font class="keywordflow">if</font> (total-&gt;bestpart == NIL) <font class="keywordflow">return</font> NIL;
00222    <font class="keywordflow">if</font> (total-&gt;numparts &gt; 8) <font class="keywordflow">return</font> NIL; <font class="comment">// later I think of something smarter</font>
00223    <font class="keywordflow">if</font> (total-&gt;numparts &lt; 3) <font class="keywordflow">return</font> NIL; <font class="comment">// less than 3 does not make sense ...</font>
00224    <a class="code" href="class_connectinfo.html">connectInfo</a> connectivity(total-&gt;numparts, total-&gt;bestpart);
00225    <a class="code" href="class_distinfo.html">distInfo</a> distance(total-&gt;nx, total-&gt;ny);
00226    <font class="keywordtype">int</font> startCost = <a class="code" href="clusterPerm.C.html#a2">clusterCost</a>(connectivity, distance);
00227    <font class="keywordtype">int</font> bestCost = INFINITY, worstCost = -INFINITY;
00228    <font class="keywordtype">int</font> *bestPerm = <font class="keyword">new</font> <font class="keywordtype">int</font>[total-&gt;numparts];
00229    <a class="code" href="clusterPerm.C.html#a4">generatePermutations</a>(bestCost, bestPerm, worstCost, connectivity, distance);
00230    cout &lt;&lt; form(<font class="stringliteral">"------ s, w, b = %d, %d, %d; perm = "</font>,
00231         startCost, worstCost, bestCost);
00232    <font class="keywordflow">for</font> (<font class="keywordtype">int</font> i = 0; i &lt; total-&gt;numparts; ++i)
00233       cout &lt;&lt; bestPerm[i] &lt;&lt; <font class="stringliteral">" "</font>;
00234    cout &lt;&lt; endl;
00235    <font class="keywordflow">if</font> (bestCost != INFINITY)
00236       <a class="code" href="clusterPerm.C.html#a5">permutateThisPartitioning</a>(total, bestPerm);
00237    <font class="keywordflow">return</font> NIL;
00238 }
</div></pre><hr><address><small>Generated at Thu Sep 28 15:37:54 2000 for madonna by
<a href="http://www.stack.nl/~dimitri/doxygen/index.html">
<img src="doxygen.gif" alt="doxygen" align=center border=0 
width=110 height=53></a>1.1.5 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy; 1997-2000</small></address>
</body>
</html>
